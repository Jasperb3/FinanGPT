Directory structure:
└── austin-starks-finangpt-pro/
    ├── README.md
    ├── LICENSE
    ├── chat.ts
    ├── package.json
    ├── tickers.csv
    ├── upload.ts
    └── src/
        ├── models/
        │   └── StockFinancials.ts
        └── services/
            ├── databases/
            │   ├── bigQuery.ts
            │   └── mongo.ts
            ├── fundamentalApi/
            │   └── EodhdClient.ts
            └── llmApi/
                ├── clients/
                │   ├── OllamaServiceClient.ts
                │   └── RequestyServiceClient.ts
                └── logs/
                    ├── ollamaChatLogs.ts
                    └── requestyChatLogs.ts

================================================
File: README.md
================================================
# Financial Data Downloader & AI Query System

This project is based on the article [Grok is Overrated. Do This To Transform ANY LLM to a Super-Intelligent Financial Analyst](https://medium.com/p/40f697092399). It downloads financial data (quarterly and annual) for stocks from EOD Historical Data and stores it in both MongoDB and Google BigQuery. It also includes an AI-powered natural language interface for querying the financial data.

For a more comprehensive, UI-based solution with additional features like algorithmic trading, check out [NexusTrade](https://nexustrade.io/).

## Prerequisites

Before you begin, ensure you have the following:

- **Node.js** (version 18 or higher) and **npm** installed.
- **MongoDB** installed and running locally or accessible via a connection string.
- **Google Cloud Platform (GCP) account** with BigQuery enabled.
- **Requesty API key** ([Sign up for Requesty here](https://app.requesty.ai/join?ref=e0603ee5) - referral link).
- An **EOD Historical Data API key** ([Sign up for a free or paid plan here](https://eodhd.com/r?ref=nexustrade) - referral link).
- (Optional) **Ollama** installed and running locally ([Download here](https://ollama.com/download)) if you want to use local LLM capabilities instead of Requesty.
- A `.env` file in the root directory with the following variables:

  ```
  CLOUD_DB="mongodb://localhost:27017/your_cloud_db" # Replace with your MongoDB connection string
  LOCAL_DB="mongodb://localhost:27017/your_local_db" # Replace with your MongoDB connection string
  EODHD_API_KEY="YOUR_EODHD_API_KEY" # Replace with your EODHD API key
  REQUESTY_API_KEY="YOUR_REQUESTY_API_KEY" # Replace with your Requesty API key
  GOOGLE_APPLICATION_CREDENTIALS_JSON='{"type": "service_account", ...}' # Replace with your GCP service account credentials JSON
  OLLAMA_SERVICE_URL="http://localhost:11434" # Optional: Only needed if using Ollama instead of Requesty
  ```

  **Important:** The `GOOGLE_APPLICATION_CREDENTIALS_JSON` environment variable should contain the _entire_ JSON content of your Google Cloud service account key. This is necessary for authenticating with BigQuery. Make sure this is properly formatted and secured.

## Setup

1.  **Clone the repository:**

    ```bash
    git clone https://github.com/austin-starks/FinAnGPT-Pro
    cd FinAnGPT-Pro
    ```

2.  **Install dependencies:**

    ```bash
    npm install
    ```

## Configuration

1.  **Create a `.env` file** in the root directory of the project. Populate it with the necessary environment variables as described in the "Prerequisites" section. **Do not commit this file to your repository!**

2.  **Set up Google Cloud credentials:**

    - Create a Google Cloud service account with BigQuery Data Editor permissions.
    - Download the service account key as a JSON file.
    - Set the `GOOGLE_APPLICATION_CREDENTIALS_JSON` environment variable to the contents of this file. **Ensure proper JSON formatting.**

## Running the Script

You have two options for running the script:

**Option 1: Using `node` directly (requires compilation)**

1.  **Compile the TypeScript code:**

    ```bash
    npm run build
    ```

    This will create a `dist` directory with the compiled JavaScript files.

2.  **Run the compiled script:**

    ```bash
    node dist/index.js
    ```

**Option 2: Using `ts-node` (for development/easier execution)**

1.  **Install `ts-node` globally (if you haven't already):**

    ```bash
    npm install -g ts-node
    ```

2.  **Run the script directly:**

    ```bash
    ts-node index.ts
    ```

## Usage

### Downloading Financial Data

1. **For all stocks in your watchlist:**

   - The project includes a `tickers.csv` file with a pre-populated list of major US stocks
   - You can modify this file to add or remove tickers (one ticker per line, skip the header row)
   - Run the upload script:

   ```bash
   ts-node upload.ts
   ```

2. **For a single stock:**
   - Modify the `upload.ts` script to use `processAndSaveEarningsForOneStock`:
   ```typescript
   // In upload.ts
   const processor = new EarningsProcessor();
   await processor.processAndSaveEarningsForOneStock("AAPL"); // Replace with your desired ticker
   ```

### File Structure

```
.
├── src/
│   ├── models/
│   │   └── StockFinancials.ts
│   └── services/
│       ├── databases/
│       │   ├── bigQuery.ts
│       │   └── mongo.ts
│       ├── fundamentalApi/
│       │   └── EodhdClient.ts
│       └── llmApi/
│           ├── clients/
│           │   ├── OllamaServiceClient.ts
│           │   └── RequestyServiceClient.ts
│           └── logs/
│               ├── ollamaChatLogs.ts
│               └── requestyChatLogs.ts
├── tickers.csv
├── .env
├── upload.ts
├── chat.ts
└── README.md
```

### Querying Financial Data with AI

The project includes a natural language interface for querying financial data. You can ask questions in plain English about the stored financial data.

To use the AI query system:

1. **Run the chat script:**

   ```bash
   ts-node chat.ts
   ```

2. **Example queries you can try:**
   - "What stocks have the highest revenue?"
   - "Show me companies with increasing free cash flow over the last 4 quarters"
   - "Which companies have the highest net income in their latest annual report?"
   - "List the top 10 companies by EBITDA margin"

The system will convert your natural language query into SQL, execute it against BigQuery, and return the results.

### Example Output

Here's a sample response when asking about companies with the highest net income:

```
Here's a summary of the stocks with the highest reported net income:

**Summary:**
The top companies by net income are primarily in the technology and finance sectors. Alphabet (GOOG/GOOGL) leads, followed by Berkshire Hathaway (BRK-A/BRK-B), Apple (AAPL), and Microsoft (MSFT).

**Top Stocks by Net Income:**

| Ticker | Symbol | Net Income (USD) | Date       |
|--------|--------|------------------|------------|
| GOOG   | GOOG   | 100,118,000,000 | 2025-02-05 |
| GOOGL  | GOOGL  | 100,118,000,000 | 2025-02-05 |
| BRK-B  | BRK-B  | 96,223,000,000  | 2024-02-26 |
| BRK-A  | BRK-A  | 96,223,000,000  | 2024-02-26 |
| AAPL   | AAPL   | 93,736,000,000  | 2024-11-01 |

**Insights:**
- The data includes both Class A and Class B shares for Alphabet and Berkshire Hathaway
- Most recent data is from early 2025 reporting period
```

## Important Considerations

- **Error Handling:** The script includes basic error handling, but you may want to enhance it for production use. Consider adding more robust logging and retry mechanisms.
- **Rate Limiting:** Be mindful of the EOD Historical Data API's rate limits. Implement appropriate delays or batching to avoid exceeding the limits.
- **Data Validation:** The script filters numeric fields before inserting into BigQuery. You may want to add more comprehensive data validation to ensure data quality.
- **BigQuery Costs:** Be aware of BigQuery's pricing model. Storing and querying large datasets can incur costs. Optimize your queries and data storage strategies to minimize expenses.
- **MongoDB Connection:** Ensure your MongoDB instance is running and accessible from the machine running the script.
- **Security:** Protect your API keys and service account credentials. Do not hardcode them in your code or commit them to your repository. Use environment variables and secure storage mechanisms.

## Contributing

Contributions are welcome! Please submit a pull request with your changes.

## License

[MIT License](LICENSE)

### Using Ollama for Local LLM Queries

This project supports using Ollama as a local LLM alternative to cloud-based services. To use Ollama:

1. **Install Ollama:**

   - Download and install from [ollama.com/download](https://ollama.com/download)
   - Follow the installation instructions for your operating system

2. **Pull your desired model:**

   ```bash
   ollama pull llama2  # or mistral, codellama, etc.
   ```

3. **Ensure Ollama is running:**

   - The service should be running on http://localhost:11434
   - Verify by checking if the service responds: `curl http://localhost:11434/api/tags`

4. **Configure the environment:**
   - Make sure your `.env` file includes: `OLLAMA_SERVICE_URL="http://localhost:11434"`
   - The system will automatically use Ollama for queries when configured


================================================
File: LICENSE
================================================
MIT License

Copyright (c) 2025 Austin Starks

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.


================================================
File: chat.ts
================================================
import RequestyServiceClient, {
  RequestyModelEnum,
} from "./src/services/llmApi/clients/RequestyServiceClient";

import Database from "./src/services/databases/mongo";
import { FinancialsDataManager } from "./src/services/databases/bigQuery";
import OllamaServiceClient from "./src/services/llmApi/clients/OllamaServiceClient";

enum LlmClients {
  REQUESTY = "requesty",
  OLLAMA = "ollama",
}

class QueryProcessor {
  private requestyClient: RequestyServiceClient;
  private ollamaClient: OllamaServiceClient;
  private financialsManager: FinancialsDataManager;

  constructor() {
    this.requestyClient = new RequestyServiceClient();
    this.ollamaClient = new OllamaServiceClient();
    this.financialsManager = new FinancialsDataManager(
      FinancialsDataManager.quarterlyTableId
    );
  }

  async processNaturalLanguageQuery(question: string, clientType: LlmClients) {
    // 1. Convert natural language to SQL using Requesty
    const systemPrompt = `You are an expert at writing BigQuery SQL queries.
    
# Financials Table Schema (\`financials.quarterly\` or \`financials.annual\`)
[
  {
    "name": "ticker",
    "type": "STRING"
  },
  {
    "name": "symbol",
    "type": "STRING"
  },
  {
    "name": "date",
    "type": "TIMESTAMP"
  },
  {
    "name": "accountsPayable",
    "type": "FLOAT"
  },
  {
    "name": "accumulatedOtherComprehensiveIncome",
    "type": "FLOAT"
  },
  {
    "name": "beginPeriodCashFlow",
    "type": "FLOAT"
  },
  {
    "name": "capitalExpenditures",
    "type": "FLOAT"
  },
  {
    "name": "capitalStock",
    "type": "FLOAT"
  },
  {
    "name": "cash",
    "type": "FLOAT"
  },
  {
    "name": "cashAndShortTermInvestments",
    "type": "FLOAT"
  },
  {
    "name": "changeInCash",
    "type": "FLOAT"
  },
  {
    "name": "changeInWorkingCapital",
    "type": "FLOAT"
  },
  {
    "name": "changeToAccountReceivables",
    "type": "FLOAT"
  },
  {
    "name": "changeToInventory",
    "type": "FLOAT"
  },
  {
    "name": "commonStock",
    "type": "FLOAT"
  },
  {
    "name": "commonStockSharesOutstanding",
    "type": "FLOAT"
  },
  {
    "name": "costOfRevenue",
    "type": "FLOAT"
  },
  {
    "name": "currentDeferredRevenue",
    "type": "FLOAT"
  },
  {
    "name": "depreciation",
    "type": "FLOAT"
  },
  {
    "name": "dividendsPaid",
    "type": "FLOAT"
  },
  {
    "name": "ebitda",
    "type": "FLOAT"
  },
  {
    "name": "endPeriodCashFlow",
    "type": "FLOAT"
  },
  {
    "name": "freeCashFlow",
    "type": "FLOAT"
  },
  {
    "name": "grossProfit",
    "type": "FLOAT"
  },
  {
    "name": "incomeBeforeTax",
    "type": "FLOAT"
  },
  {
    "name": "incomeTaxExpense",
    "type": "FLOAT"
  },
  {
    "name": "inventory",
    "type": "FLOAT"
  },
  {
    "name": "investments",
    "type": "FLOAT"
  },
  {
    "name": "liabilitiesAndStockholdersEquity",
    "type": "FLOAT"
  },
  {
    "name": "longTermDebt",
    "type": "FLOAT"
  },
  {
    "name": "longTermInvestments",
    "type": "FLOAT"
  },
  {
    "name": "netDebt",
    "type": "FLOAT"
  },
  {
    "name": "netIncome",
    "type": "FLOAT"
  },
  {
    "name": "netIncomeFromContinuingOps",
    "type": "FLOAT"
  },
  {
    "name": "netInvestedCapital",
    "type": "FLOAT"
  },
  {
    "name": "netReceivables",
    "type": "FLOAT"
  },
  {
    "name": "netWorkingCapital",
    "type": "FLOAT"
  },
  {
    "name": "nonCurrentAssetsTotal",
    "type": "FLOAT"
  },
  {
    "name": "nonCurrentLiabilitiesOther",
    "type": "FLOAT"
  },
  {
    "name": "nonCurrentLiabilitiesTotal",
    "type": "FLOAT"
  },
  {
    "name": "nonCurrrentAssetsOther",
    "type": "FLOAT"
  },
  {
    "name": "operatingIncome",
    "type": "FLOAT"
  },
  {
    "name": "otherCashflowsFromFinancingActivities",
    "type": "FLOAT"
  },
  {
    "name": "otherCashflowsFromInvestingActivities",
    "type": "FLOAT"
  },
  {
    "name": "otherCurrentAssets",
    "type": "FLOAT"
  },
  {
    "name": "otherCurrentLiab",
    "type": "FLOAT"
  },
  {
    "name": "otherNonCashItems",
    "type": "FLOAT"
  },
  {
    "name": "otherOperatingExpenses",
    "type": "FLOAT"
  },
  {
    "name": "propertyPlantAndEquipmentGross",
    "type": "FLOAT"
  },
  {
    "name": "propertyPlantAndEquipmentNet",
    "type": "FLOAT"
  },
  {
    "name": "reconciledDepreciation",
    "type": "FLOAT"
  },
  {
    "name": "researchDevelopment",
    "type": "FLOAT"
  },
  {
    "name": "retainedEarnings",
    "type": "FLOAT"
  },
  {
    "name": "salePurchaseOfStock",
    "type": "FLOAT"
  },
  {
    "name": "sellingGeneralAdministrative",
    "type": "FLOAT"
  },
  {
    "name": "shortLongTermDebt",
    "type": "FLOAT"
  },
  {
    "name": "shortLongTermDebtTotal",
    "type": "FLOAT"
  },
  {
    "name": "shortTermDebt",
    "type": "FLOAT"
  },
  {
    "name": "shortTermInvestments",
    "type": "FLOAT"
  },
  {
    "name": "stockBasedCompensation",
    "type": "FLOAT"
  },
  {
    "name": "taxProvision",
    "type": "FLOAT"
  },
  {
    "name": "totalAssets",
    "type": "FLOAT"
  },
  {
    "name": "totalCashFromFinancingActivities",
    "type": "FLOAT"
  },
  {
    "name": "totalCashFromOperatingActivities",
    "type": "FLOAT"
  },
  {
    "name": "totalCurrentAssets",
    "type": "FLOAT"
  },
  {
    "name": "totalCurrentLiabilities",
    "type": "FLOAT"
  },
  {
    "name": "totalLiab",
    "type": "FLOAT"
  },
  {
    "name": "totalOperatingExpenses",
    "type": "FLOAT"
  },
  {
    "name": "totalOtherIncomeExpenseNet",
    "type": "FLOAT"
  },
  {
    "name": "totalRevenue",
    "type": "FLOAT"
  },
  {
    "name": "totalStockholderEquity",
    "type": "FLOAT"
  },
  {
    "name": "depreciationAndAmortization",
    "type": "FLOAT"
  },
  {
    "name": "ebit",
    "type": "FLOAT"
  },
  {
    "name": "otherStockholderEquity",
    "type": "FLOAT"
  },
  {
    "name": "interestExpense",
    "type": "FLOAT"
  },
  {
    "name": "capitalLeaseObligations",
    "type": "FLOAT"
  },
  {
    "name": "capitalSurpluse",
    "type": "FLOAT"
  },
  {
    "name": "cashAndCashEquivalentsChanges",
    "type": "FLOAT"
  },
  {
    "name": "cashAndEquivalents",
    "type": "FLOAT"
  },
  {
    "name": "changeReceivables",
    "type": "FLOAT"
  },
  {
    "name": "interestIncome",
    "type": "FLOAT"
  },
  {
    "name": "longTermDebtTotal",
    "type": "FLOAT"
  },
  {
    "name": "netIncomeApplicableToCommonShares",
    "type": "FLOAT"
  },
  {
    "name": "netInterestIncome",
    "type": "FLOAT"
  },
  {
    "name": "nonOperatingIncomeNetOther",
    "type": "FLOAT"
  },
  {
    "name": "otherAssets",
    "type": "FLOAT"
  },
  {
    "name": "propertyPlantEquipment",
    "type": "FLOAT"
  },
  {
    "name": "totalCashflowsFromInvestingActivities",
    "type": "FLOAT"
  },
  {
    "name": "accumulatedDepreciation",
    "type": "FLOAT"
  },
  {
    "name": "cashFlowsOtherOperating",
    "type": "FLOAT"
  },
  {
    "name": "changeToLiabilities",
    "type": "FLOAT"
  },
  {
    "name": "changeToNetincome",
    "type": "FLOAT"
  },
  {
    "name": "changeToOperatingActivities",
    "type": "FLOAT"
  },
  {
    "name": "commonStockTotalEquity",
    "type": "FLOAT"
  },
  {
    "name": "netBorrowings",
    "type": "FLOAT"
  },
  {
    "name": "netTangibleAssets",
    "type": "FLOAT"
  },
  {
    "name": "otherLiab",
    "type": "FLOAT"
  },
  {
    "name": "retainedEarningsTotalEquity",
    "type": "FLOAT"
  },
  {
    "name": "issuanceOfCapitalStock",
    "type": "FLOAT"
  },
  {
    "name": "additionalPaidInCapital",
    "type": "FLOAT"
  },
  {
    "name": "deferredLongTermLiab",
    "type": "FLOAT"
  },
  {
    "name": "discontinuedOperations",
    "type": "FLOAT"
  },
  {
    "name": "effectOfAccountingCharges",
    "type": "FLOAT"
  },
  {
    "name": "extraordinaryItems",
    "type": "FLOAT"
  },
  {
    "name": "goodWill",
    "type": "FLOAT"
  },
  {
    "name": "minorityInterest",
    "type": "FLOAT"
  },
  {
    "name": "nonRecurring",
    "type": "FLOAT"
  },
  {
    "name": "noncontrollingInterestInConsolidatedEntity",
    "type": "FLOAT"
  },
  {
    "name": "otherItems",
    "type": "FLOAT"
  },
  {
    "name": "preferredStockTotalEquity",
    "type": "FLOAT"
  },
  {
    "name": "temporaryEquityRedeemableNoncontrollingInterests",
    "type": "FLOAT"
  },
  {
    "name": "totalPermanentEquity",
    "type": "FLOAT"
  },
  {
    "name": "treasuryStock",
    "type": "FLOAT"
  },
  {
    "name": "intangibleAssets",
    "type": "FLOAT"
  },
  {
    "name": "sellingAndMarketingExpenses",
    "type": "FLOAT"
  },
  {
    "name": "warrants",
    "type": "FLOAT"
  },
  {
    "name": "accumulatedAmortization",
    "type": "FLOAT"
  },
  {
    "name": "deferredLongTermAssetCharges",
    "type": "FLOAT"
  },
  {
    "name": "exchangeRateChanges",
    "type": "FLOAT"
  },
  {
    "name": "negativeGoodwill",
    "type": "FLOAT"
  },
  {
    "name": "preferredStockAndOtherAdjustments",
    "type": "FLOAT"
  },
  {
    "name": "preferredStockRedeemable",
    "type": "FLOAT"
  },
  {
    "name": "earningAssets",
    "type": "FLOAT"
  }
]

The database has a table called 'financials.quarterly' and 'financials.annual' with the above columns.
Respond only with the SQL query, no explanation. You are allowed to write comments in the query.
The query should be valid BigQuery SQL.

# CONSTRAINTS:
- The default limit of results is 25. The maximum is 100. If they ask for more than 100, use the limit.
- Always include the date and raw values in the response.

# RESPONSE FORMAT:
\`\`\`sql
-- Comment (if needed)
SELECT * FROM \`financials.quarterly\` -- This table might be annual or quarterly. There might be where clauses, joins, or whatever is needed to answer the question.
\`\`\`

# Examples:

// Example 1:
User: "What stocks have the highest revenue?"
Assistant:
\`\`\`sql
-- Query to retrieve stocks with the highest revenue from each stock's latest annual report
WITH LatestAnnual AS (
  SELECT
    date,
    ticker,
    symbol,
    totalRevenue,
    ROW_NUMBER() OVER (PARTITION BY ticker ORDER BY date DESC) AS rn
  FROM \`financials.annual\`
)
SELECT
  date,
  ticker,
  symbol,
  totalRevenue
FROM LatestAnnual
WHERE rn = 1
ORDER BY totalRevenue DESC
LIMIT 10;
\`\`\`

// Example 2:
User: "What stocks have increased their free cash flow every quarter for the last 4 quarters? Sort by their current free cash flow as of the last quarter descending"
Assistant:
\`\`\`sql
-- Query to retrieve stocks with increasing free cash flow over the last 4 quarters, sorted by the most recent quarter's free cash flow in descending order
WITH Last4Quarters AS (
  SELECT
    ticker,
    symbol,
    freeCashFlow,
    date,
    ROW_NUMBER() OVER (PARTITION BY ticker ORDER BY date DESC) AS rn
  FROM \`financials.quarterly\`
)
SELECT
  t1.date,
  t1.ticker,
  t1.symbol,
  t1.freeCashFlow AS current_freeCashFlow
FROM Last4Quarters t1
JOIN Last4Quarters t2 ON t1.ticker = t2.ticker AND t2.rn = 2
JOIN Last4Quarters t3 ON t1.ticker = t3.ticker AND t3.rn = 3
JOIN Last4Quarters t4 ON t1.ticker = t4.ticker AND t4.rn = 4
WHERE t4.freeCashFlow < t3.freeCashFlow
  AND t3.freeCashFlow < t2.freeCashFlow
  AND t2.freeCashFlow < t1.freeCashFlow
ORDER BY t1.freeCashFlow DESC
LIMIT 25;
\`\`\`
    `;
    console.log(`Sending Request to ${clientType}`);
    const client =
      clientType === LlmClients.REQUESTY
        ? this.requestyClient
        : this.ollamaClient;

    const response = await client.sendRequest({
      systemPrompt,
      model: client.getModel(),
      temperature: 1,
      messages: [
        {
          sender: "User",
          content: `Convert this question to a SQL query: ${question}`,
        },
      ],
      userId: "system",
    });
    const content = client.getChatResponseContent(response as any);
    const sqlQuery = content
      ?.trim()
      .replace(/^```sql\n?/, "") // Remove opening ```sql
      .replace(/^```\n?/, "") // Remove opening ``` (if no sql)
      .replace(/\n?```$/, ""); // Remove closing ```
    if (!sqlQuery) {
      throw new Error("No SQL query generated");
    }
    console.log("Generated SQL Query:", sqlQuery);

    // 3. Execute the query against BigQuery
    try {
      const results = await this.financialsManager.executeQuery(sqlQuery);

      // 4. Format results using LLM
      const formatPrompt = `You are a financial analyst assistant. Format and summarize the following SQL query results in markdown.
The original question was: "${question}"

Include:
- A brief summary of the findings
- A markdown table with the key data
- Any relevant insights or patterns

Keep the response concise and focused on answering the user's question.`;

      const model = client.getModel();
      const formattedResponse = await client.sendRequest({
        systemPrompt: formatPrompt,
        model,
        temperature: 1,
        messages: [
          {
            sender: "User",
            content: `SQL Results: ${JSON.stringify(results, null, 2)}`,
          },
        ],
        userId: "system",
      });

      const summary = client.getChatResponseContent(formattedResponse as any);
      console.log("Formatted Response:", summary);
      return summary;
    } catch (error) {
      console.error("Error executing query:", error);
      throw error;
    }
  }
}

(async () => {
  try {
    const db = new Database("local");
    await db.connect();
    const queryProcessor = new QueryProcessor();
    const results = await queryProcessor.processNaturalLanguageQuery(
      "What stocks have the highest income (annual) right now?",
      LlmClients.REQUESTY
    );

    console.log("Query Results:", results);
  } catch (error) {
    console.error("Error:", error);
  } finally {
    process.exit(0);
  }
})();


================================================
File: package.json
================================================
{
  "name": "eodhd",
  "version": "1.0.0",
  "description": "Uploads EODHD data to BigQuery",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "keywords": [
    "algorithmic",
    "trading",
    "trading",
    "investing",
    "financial",
    "analysis",
    "finance",
    "ai",
    "gpt",
    "grok"
  ],
  "author": "Austiin Starks",
  "license": "ISC",
  "devDependencies": {
    "@types/node": "^22.13.5"
  },
  "dependencies": {
    "@google-cloud/bigquery": "^7.9.2",
    "axios": "^1.7.9",
    "dotenv": "^16.4.7",
    "moment": "^2.30.1",
    "moment-timezone": "^0.5.47",
    "mongodb": "^6.13.1",
    "mongoose": "^8.10.1"
  }
}


================================================
File: tickers.csv
================================================
Tickers
A
AA
AACI
AADI
AAIC
AAL
AAMC
AAN
AAOI
AAON
AAP
AAPL
AAT
AB
ABBV
ABCB
ABEO
ABIO
ABL
ABM
ABNB
ABOS
ABSI
ABT
ABUS
ABVC
AC
ACA
ACAB
ACAD
ACAH
ACAHU
ACAX
ACCD
ACEL
ACET
ACHC
ACHR
ACI
ACIC
ACIW
ACLX
ACM
ACMR
ACNB
ACON
ACOR
ACR
ACRE
ACRO
ACRS
ACRV
ACRX
ACST
ACT
ACTG
ACU
ACVA
ACXP
ADBE
ADC
ADES
ADI
ADM
ADMA
ADP
ADPT
ADRT
ADSK
ADT
ADTH
ADTN
ADTX
ADUS
ADV
ADVM
AE
AEAE
AEE
AEHA
AEHR
AEI
AEIS
AEL
AEMD
AEO
AEP
AES
AESI
AEVA
AEY
AEYE
AFBI
AFCG
AFG
AFIB
AFL
AFRM
AGAE
AGE
AGEN
AGFS
AGFY
AGIL
AGIO
AGL
AGLE
AGNC
AGNCM
AGNCN
AGR
AGRX
AGS
AGTC
AGTI
AGX
AGYS
AHCO
AHT
AI
AIG
AIM
AIMD
AIN
AINC
AIP
AIR
AIRC
AIRG
AIRI
AIRS
AIRT
AIRTP
AIT
AIV
AIZ
AJG
AKA
AKBA
AKR
AKRO
AKTS
AKUS
AKYA
AL
ALAB
ALB
ALCO
ALDX
ALE
ALEC
ALEX
ALG
ALGM
ALGS
ALGT
ALHC
ALIM
ALK
ALKT
ALL
ALLK
ALLO
ALLR
ALLY
ALNT
ALNY
ALOT
ALPN
ALPP
ALRN
ALRS
ALSN
ALT
ALTG
ALTO
ALTR
ALTU
ALTUU
ALVR
ALX
ALXO
ALZN
AM
AMAL
AMAM
AMAO
AMAT
AMBA
AMBC
AMBO
AMC
AMCX
AMD
AME
AMED
AMG
AMGN
AMIX
AMK
AMLX
AMNB
AMP
AMPE
AMPG
AMPH
AMPL
AMPX
AMPY
AMR
AMRC
AMRK
AMRS
AMRX
AMS
AMSC
AMSF
AMST
AMSWA
AMT
AMTI
AMTX
AMWD
AMWL
AMZN
AN
ANAB
ANDE
ANEB
ANET
ANF
ANGO
ANIK
ANIP
ANIX
ANNX
ANSS
ANVS
ANY
AOGO
AOMR
AORT
AOS
AOSL
AOUT
AP
APA
APAM
APCX
APD
APDN
APEI
APG
APH
API
APLD
APLE
APLS
APLT
APO
APOG
APPF
APPN
APPS
APRE
APRN
APVO
APYX
AQB
AQMS
AQST
AR
ARAV
ARAY
ARBGU
ARC
ARCC
ARCH
ARCK
ARCT
ARE
AREC
AREN
ARES
ARGU
ARHS
ARI
ARIS
ARIZ
ARKO
ARKR
ARL
ARLO
ARMK
ARMP
AROC
ARQT
ARR
ARRW
ARRWU
ARRY
ARTE
ARTL
ARTLW
ARTNA
ARTW
ARVN
ARW
ARWR
ASA
ASAN
ASB
ASH
ASLE
ASMB
ASO
ASRT
ASRV
ASTC
ASTE
ASTH
ASTI
ASTR
ASTS
ASUR
ASXC
ASYS
ATCH
ATEC
ATER
ATEX
ATGE
ATHA
ATIF
ATIP
ATKR
ATLC
ATLCP
ATLO
ATNF
ATNM
ATO
ATOM
ATOS
ATR
ATRA
ATRC
ATRI
ATRO
ATSG
ATUS
ATXI
ATXS
AU
AUB
AUBN
AUGX
AUID
AULT
AUMN
AUR
AURA
AUUD
AUVI
AVA
AVAH
AVAV
AVB
AVD
AVDX
AVGO
AVGR
AVHI
AVIR
AVNS
AVNT
AVNW
AVO
AVPT
AVRO
AVT
AVTE
AVTR
AVTX
AVXL
AWH
AWI
AWK
AWR
AWRE
AWX
AX
AXDX
AXGN
AXL
AXLA
AXNX
AXON
AXP
AXR
AXSM
AXTA
AXTI
AYI
AYRO
AYTU
AYX
AZEK
AZO
AZPN
AZTA
AZZ
B
BA
BACA
BAFN
BAH
BALY
BAND
BANF
BANX
BARK
BASE
BATL
BATRA
BATRK
BBAI
BBCP
BBGI
BBLG
BBSI
BBUC
BBW
BBWI
BBY
BC
BCAB
BCAL
BCAT
BCBP
BCC
BCDA
BCEL
BCLI
BCML
BCO
BCOV
BCOW
BCRX
BCSF
BCV
BDC
BDL
BDSX
BDTX
BDX
BE
BEAM
BEAT
BECN
BEEM
BELFA
BELFB
BEN
BEPC
BERY
BF-A
BF-B
BFC
BFH
BFI
BFIN
BFK
BFLY
BFRI
BFS
BFZ
BG
BGC
BGFV
BGR
BGRY
BGS
BGSF
BGXX
BH
BH-A
BHF
BHFAP
BHG
BHIL
BHK
BHLB
BHR
BHRB
BHV
BIG
BIGZ
BIIB
BILL
BIMI
BIO
BIO-B
BIOL
BIOR
BIPC
BIRD
BIT
BITE
BIVI
BJ
BJDX
BJRI
BK
BKCC
BKD
BKE
BKH
BKKT
BKN
BKNG
BKR
BKSY
BKTI
BKU
BKYI
BLBD
BLBX
BLD
BLDE
BLDR
BLE
BLFS
BLFY
BLIN
BLMN
BLND
BLNK
BLTE
BLW
BLZE
BMAC
BMBL
BME
BMEA
BMI
BMRA
BMTX
BMY
BNED
BNGO
BNIX
BNL
BNY
BOC
BODI
BOKF
BOLT
BOOM
BOOT
BOTJ
BOWL
BOX
BOXL
BPMC
BPOP
BPRN
BPT
BPTH
BR
BRAC
BRACU
BRBR
BRBS
BRC
BRCC
BRD
BRDG
BREZ
BRFH
BRID
BRK-A
BRK-B
BRKH
BRKL
BRLT
BRN
BRO
BROS
BRP
BRSP
BRT
BRX
BRY
BRZE
BSBK
BSET
BSFC
BSGM
BSIG
BSM
BSQR
BSRR
BSTZ
BSVN
BSX
BSY
BTA
BTAI
BTBD
BTCS
BTCY
BTMD
BTT
BTTR
BTTX
BTU
BTZ
BUI
BURL
BV
BVFL
BVH
BVS
BW
BWA
BWB
BWEN
BWMN
BWV
BWXT
BX
BXC
BXMT
BXP
BXRX
BXSL
BY
BYD
BYFC
BYM
BYN
BYND
BYRN
BYSI
BZFD
BZH
CABA
CACC
CACI
CADE
CADL
CAG
CAH
CAKE
CAL
CALB
CALM
CALX
CANB
CANO
CAPL
CAPR
CAR
CARA
CARE
CARG
CARM
CARR
CARS
CARV
CASA
CASH
CASY
CAT
CATC
CATO
CATY
CAVA
CBAN
CBAY
CBFV
CBNK
CBRE
CBRL
CBSH
CBT
CBU
CBZ
CC
CCAP
CCB
CCCC
CCCS
CCEL
CCF
CCI
CCL
CCLP
CCNE
CCO
CCOI
CCRD
CCRN
CCS
CCSI
CCV
CCVI
CDLX
CDMO
CDNA
CDRE
CDTX
CDXC
CDXS
CDZI
CEAD
CECO
CEG
CEI
CEIX
CELC
CELH
CELZ
CENT
CENTA
CERE
CET
CETX
CETXP
CETY
CEV
CEVA
CF
CFB
CFFE
CFFEU
CFFI
CFFN
CFFS
CFG
CFIV
CFIVU
CFLT
CFMS
CFR
CFSB
CG
CGBD
CGEM
CGNX
CGTX
CHCI
CHCO
CHCT
CHD
CHDN
CHE
CHEF
CHGG
CHH
CHK
CHMI
CHPT
CHRD
CHRS
CHRW
CHS
CHTR
CHUY
CHWY
CHX
CI
CIA
CIEN
CIFR
CIM
CING
CION
CISO
CIVB
CIVI
CIX
CIZN
CKPT
CKX
CL
CLAR
CLB
CLBK
CLDT
CLDX
CLF
CLFD
CLH
CLIN
CLMB
CLMT
CLNE
CLNN
CLOE
CLOV
CLPR
CLPT
CLSD
CLSK
CLST
CLVS
CLX
CLXT
CMAX
CMBM
CMC
CMCO
CMCSA
CMCT
CMG
CMI
CMLS
CMP
CMPO
CMPX
CMRA
CMRX
CMS
CMT
CMTG
CMTL
CMU
CNA
CNC
CNDA
CNDB
CNDT
CNFR
CNGL
CNK
CNM
CNMD
CNNE
CNP
CNS
CNSL
CNSP
CNTB
CNTX
CNTY
CNX
CNXA
CNXC
COCO
COCP
CODA
CODI
CODX
COF
COFS
COGT
COHN
COHR
COHU
COIN
COKE
COLB
COLL
COMM
COMS
CONN
CONX
CONXU
COO
COOK
COOP
COP
COR
CORR
CORT
COST
COTY
CPAA
CPB
CPE
CPF
CPHC
CPIX
CPK
CPNG
CPRT
CPRX
CPS
CPSS
CPT
CPTN
CPZ
CQP
CRAI
CRBG
CRBP
CRBU
CRC
CRCT
CRD-A
CRD-B
CRDF
CREX
CRGE
CRGY
CRI
CRIS
CRKN
CRL
CRM
CRMD
CRMT
CRNC
CRNX
CROX
CRS
CRT
CRUS
CRVL
CRVS
CRWD
CRWS
CSBR
CSCO
CSGP
CSGS
CSL
CSPI
CSR
CSSE
CSSEP
CSTL
CSTR
CSV
CSWC
CSWI
CSX
CTAS
CTBI
CTG
CTHR
CTKB
CTLP
CTLT
CTMX
CTOS
CTRA
CTRE
CTRN
CTSH
CTSO
CTV
CTVA
CTXR
CUBE
CUE
CUEN
CUK
CULL
CURI
CUTR
CUZ
CVBF
CVCO
CVCY
CVEO
CVGI
CVGW
CVI
CVII
CVLT
CVLY
CVM
CVNA
CVR
CVRX
CVS
CVU
CVV
CW
CWBC
CWBR
CWEN
CWEN-A
CWH
CWST
CWT
CXDO
CXE
CXH
CXM
CXT
CYAN
CYCC
CYCCP
CYCN
CYH
CYN
CYRX
CYT
CYTK
CZFS
CZNC
CZR
CZWI
D
DAIO
DAKT
DAL
DALN
DAN
DAR
DARE
DASH
DATS
DAVE
DAWN
DBGI
DBI
DBRG
DBTX
DCGO
DCI
DCO
DCOM
DCPH
DCTH
DD
DDOG
DDS
DE
DEA
DECK
DEI
DELL
DENN
DERM
DFFN
DFH
DFIN
DFS
DG
DGICA
DGICB
DGII
DGLY
DGX
DH
DHAC
DHC
DHI
DHIL
DHR
DHX
DIBS
DICE
DIN
DIOD
DIS
DISH
DIT
DJCO
DJT
DK
DKL
DKNG
DKS
DLA
DLB
DLHC
DLPN
DLR
DLTH
DLTR
DM
DMAC
DMAQ
DMF
DMLP
DMRC
DMTK
DNA
DNLI
DNMR
DNOW
DNUT
DO
DOC
DOCN
DOCS
DOCU
DOMA
DOMO
DOOR
DORM
DOUG
DOV
DOW
DOX
DPSI
DPZ
DRH
DRI
DRIO
DRMA
DRQ
DRRX
DRVN
DSAQ
DSGN
DSGR
DSKE
DSP
DT
DTC
DTE
DTF
DTIL
DTM
DTST
DUNE
DUNEU
DUOL
DUOT
DV
DVA
DVN
DX
DXC
DXCM
DXLG
DXPE
DXR
DXYN
DY
DYAI
DYN
DYNT
EA
EAC
EACPU
EAF
EAR
EARN
EAST
EAT
EB
EBAY
EBF
EBIX
EBMT
EBS
ECC
ECF
ECOR
ECPG
ECVT
ED
EDBL
EDIT
EDR
EDUC
EE
EEFT
EEX
EFC
EFOI
EFR
EFT
EFTR
EFX
EGAN
EGBN
EGGF
EGHT
EGIO
EGLE
EGP
EGRX
EGY
EHTH
EIC
EIG
EIGR
EIX
EKSO
EL
ELA
ELAN
ELEV
ELF
ELMD
ELME
ELSE
ELV
ELVN
ELYM
EMBC
EMBK
EME
EMKR
EML
EMLD
EMN
EMR
ENER
ENFN
ENG
ENLC
ENOV
ENPH
ENR
ENS
ENSC
ENSG
ENSV
ENTA
ENTG
ENV
ENVA
ENVB
ENVX
ENX
ENZ
EOG
EOLS
EOSE
EOT
EP
EPAC
EPC
EPD
EPM
EPR
EPRT
EQ
EQC
EQIX
EQR
EQS
EQT
ERAS
ERC
ERIE
ERII
ES
ESAB
ESCA
ESE
ESI
ESMT
ESOA
ESP
ESPR
ESQ
ESS
ESSA
ET
ETD
ETNB
ETON
ETR
ETRN
ETSY
ETWO
ETX
EU
EVA
EVBG
EVBN
EVC
EVCM
EVER
EVEX
EVF
EVGO
EVI
EVLO
EVLV
EVM
EVN
EVOK
EVR
EVRG
EVRI
EVTC
EW
EWCZ
EWTX
EXAS
EXC
EXEL
EXFY
EXLS
EXP
EXPE
EXPR
EXR
EXTR
EYE
EYEG
EYEN
EYPT
EZFL
EZPW
F
FA
FANG
FARM
FARO
FAST
FAT
FATBB
FATBP
FATE
FATH
FBIN
FBIO
FBIOP
FBIZ
FBK
FBMS
FBNC
FBRT
FBRX
FC
FCAP
FCBC
FCEL
FCF
FCFS
FCN
FCNCA
FCPT
FCX
FDBC
FDMT
FDS
FDUS
FDX
FE
FEIM
FEMY
FENC
FEXD
FF
FFBC
FFIC
FFIE
FFIN
FFIV
FFNW
FG
FGBI
FGEN
FGF
FHB
FHLT
FHN
FHTX
FI
FIAC
FICO
FIGS
FINS
FINW
FIS
FISI
FITB
FITBI
FIVE
FIX
FIXX
FIZZ
FKWL
FL
FLEX
FLGC
FLGT
FLIC
FLL
FLME
FLNC
FLNT
FLO
FLR
FLS
FLT
FLUX
FLWS
FLXS
FLYW
FLYX
FMBH
FMC
FNCB
FNCH
FND
FNKO
FNLC
FNWD
FOA
FOLD
FONR
FOR
FORA
FORD
FORR
FOSL
FOUR
FOX
FOXA
FOXF
FPAY
FPH
FPI
FR
FRAF
FRBA
FRBK
FRD
FREE
FREQ
FRGE
FRLA
FRME
FRPH
FRPT
FRSH
FRT
FRXB
FSBW
FSCO
FSEA
FSFG
FSK
FSLR
FSNB
FSP
FSR
FSRX
FSRXU
FSS
FT
FTAI
FTCI
FTDR
FTEK
FTFT
FTI
FTK
FTLF
FTPA
FUBO
FUL
FULC
FULT
FUN
FUSB
FUV
FVCB
FWBI
FWONA
FWONK
FWRD
FWRG
FXCO
FXNC
FYBR
GAIA
GAIN
GALT
GAM
GAMC
GAMCU
GAN
GANX
GAP
GATX
GBAB
GBBK
GBDC
GBIO
GBLI
GBNY
GBR
GBTG
GBX
GCBC
GCI
GCO
GCTK
GD
GDDY
GDEN
GDNR
GDOT
GDRX
GDST
GE
GECC
GEF
GEF-B
GEG
GEHC
GEN
GENC
GEO
GEOS
GERN
GES
GEV
GEVO
GFF
GGG
GGT
GGZ
GH
GHC
GHL
GHLD
GHM
GHSI
GIC
GIFI
GIII
GIPR
GIS
GIW
GKOS
GL
GLAD
GLBZ
GLLI
GLP
GLPI
GLSI
GLT
GLU
GLUE
GLW
GLYC
GM
GME
GMED
GMFI
GMGI
GMRE
GMS
GNE
GNL
GNLX
GNPX
GNRC
GNSS
GNT
GNTX
GNTY
GNW
GO
GOCO
GOEV
GOGO
GOLF
GOOD
GOODO
GOOG
GOOGL
GORO
GOSS
GOVX
GPI
GPK
GPN
GPOR
GPP
GPRE
GPS
GRBK
GREE
GRF
GRNA
GRND
GRNT
GROM
GROV
GROW
GRPH
GRPN
GRTS
GRTX
GRWG
GRX
GSAT
GSBD
GSHD
GSIT
GSRM
GT
GTBP
GTEC
GTES
GTHX
GTIM
GTLB
GTLS
GTN
GTN-A
GTY
GVA
GVP
GWH
GWRE
GWRS
GWW
GXO
H
HA
HAE
HAIN
HAL
HALL
HALO
HARP
HASI
HAYN
HAYW
HBAN
HBB
HBCP
HBI
HBIO
HBNC
HBT
HCA
HCAT
HCC
HCDI
HCI
HCKT
HCP
HCSG
HCVI
HCWB
HD
HDSN
HE
HEAR
HEES
HEI
HEI-A
HELE
HEP
HESM
HFBL
HFFG
HFWA
HGBL
HGTY
HGV
HHH
HI
HIBB
HIFS
HIG
HII
HIMS
HIPO
HIW
HL
HLF
HLI
HLIO
HLIT
HLLY
HLMN
HLNE
HLT
HLTH
HLVX
HLX
HMCO
HMCOU
HMN
HMNF
HNNA
HNRA
HNRG
HNST
HNW
HOFT
HOFV
HOLX
HOMB
HON
HONE
HOOD
HOOK
HOPE
HOTH
HOUR
HOV
HOWL
HP
HPE
HPK
HPLT
HPP
HPQ
HQH
HQI
HQL
HQY
HR
HRB
HRI
HRL
HRMY
HROW
HRT
HRTG
HRTX
HRZN
HSCS
HSDT
HSIC
HSII
HSON
HSTM
HSY
HT
HTBI
HTGC
HTH
HTLD
HTLF
HTZ
HUBB
HUBS
HUM
HUMA
HUN
HURC
HURN
HUSA
HVT
HVT-A
HWBK
HWC
HWEL
HWKN
HWM
HXL
HY
HYFM
HYLN
HYMC
HYPR
HYZN
HZO
IART
IAS
IAUX
IBCP
IBEX
IBIO
IBOC
IBP
IBRX
IBTA
IBTX
ICAD
ICCC
ICCH
ICCT
ICD
ICE
ICFI
ICMB
ICUI
ICVX
ID
IDA
IDAI
IDCC
IDEX
IDN
IDT
IDYA
IE
IEP
IESC
IEX
IGC
IGI
IGMS
IGTA
IHRT
IHT
III
IIIN
IIIV
IIM
IIVI
IKNA
IKT
ILMN
ILPT
IMAQ
IMGN
IMKTA
IMMR
IMMX
IMNM
IMPL
IMRX
IMUX
IMVT
IMXI
INAB
INAQ
INBX
INCY
INDB
INDI
INDP
INFN
INFU
INGN
INGR
INKA
INKT
INLX
INMB
INN
INNV
INO
INOD
INOV
INPX
INSE
INSM
INSP
INST
INSW
INTA
INTC
INTG
INTS
INTT
INTU
INTZ
INUV
INVA
INVE
INVH
INVO
INZY
IONM
IONQ
IONS
IOR
IOSP
IOT
IOVA
IPAR
IPDN
IPG
IPGP
IPI
IPSC
IPVF
IPW
IQI
IQV
IR
IRBT
IRDM
IRIX
IRM
IRON
IROQ
IRRX
IRT
IRWD
ISDR
ISO
ISPC
ISPO
ISRG
ISSC
ISTR
ISUN
IT
ITI
ITIC
ITOS
ITRI
ITT
ITW
IVAC
IVDA
IVR
IVT
J
JACK
JAGX
JAMF
JAN
JANX
JAQC
JBGS
JBI
JBL
JBLU
JBSS
JBT
JCTCF
JEF
JELD
JHI
JHS
JILL
JJSF
JKHY
JLL
JMSB
JNJ
JOAN
JOB
JOE
JOUT
JPM
JRSH
JSPR
JVA
JWN
JYNT
KALA
KALU
KALV
KAMN
KAR
KAVL
KBH
KBNT
KBR
KD
KDNY
KDP
KE
KELYA
KELYB
KEM
KEQU
KEX
KEYS
KFFB
KFS
KFY
KHC
KIDS
KIND
KIRK
KKR
KLAC
KLIC
KLTR
KLXE
KMB
KMI
KMPR
KMT
KMX
KN
KNSW
KNTE
KNTK
KNX
KO
KOD
KODK
KOP
KOPN
KORE
KOS
KOSS
KPLT
KPLTW
KPRX
KPTI
KR
KRBP
KRC
KREF
KRG
KRMD
KRNY
KRO
KRON
KROS
KRT
KRTX
KRUS
KRYS
KSCP
KSS
KTB
KTCC
KTF
KTOS
KTTA
KULR
KURA
KVHI
KVSA
KVUE
KW
KWR
KYMR
KYN
KZR
L
LAB
LABP
LADR
LAKE
LAMR
LANC
LAND
LANDM
LANDP
LARK
LASR
LAUR
LAW
LAZR
LAZY
LBAI
LBBB
LBC
LBPH
LBRDA
LBRDK
LBRT
LC
LCA
LCAHU
LCID
LCTX
LCUT
LDI
LDOS
LE
LEA
LEE
LEG
LEGH
LEGN
LEN
LEN-B
LEO
LESL
LEU
LEVI
LFLY
LFMD
LFST
LFT
LFVN
LGF-A
LGF-B
LGIH
LGL
LGMK
LGND
LGVN
LH
LHX
LIAN
LIBY
LIDR
LIFE
LII
LINC
LIND
LINK
LITE
LITT
LIVE
LIXT
LKFN
LKQ
LL
LLAP
LLY
LMACA
LMACU
LMAT
LMB
LMFA
LMND
LMNR
LMT
LNC
LNG
LNN
LNSR
LNTH
LNW
LOAN
LOB
LOCC
LOCL
LOCO
LODE
LOGC
LOPE
LOVE
LOW
LPCN
LPG
LPLA
LPRO
LPSN
LPTH
LPTV
LPTX
LPX
LQDA
LQDT
LRCX
LRFC
LRMR
LRN
LSBK
LSCC
LSEA
LSF
LSH
LSXMA
LSXMB
LSXMK
LTBR
LTC
LTH
LTHM
LTRN
LTRX
LTRY
LUCD
LUMN
LUMO
LUNA
LUNG
LUV
LVAC
LVLU
LVO
LVOX
LVS
LW
LWAY
LWLG
LXFR
LXP
LXRX
LXU
LYB
LYEL
LYFT
LYRA
LYTS
LZ
LZB
M
MA
MAA
MAC
MACK
MAIN
MAMA
MAN
MANH
MAPS
MAQC
MAR
MARA
MARK
MARPS
MAS
MASI
MASS
MAT
MATW
MATX
MAV
MAX
MAYS
MBAC
MBAY
MBI
MBINP
MBIO
MBOT
MBRX
MBUU
MBWM
MC
MCB
MCBC
MCBS
MCD
MCFT
MCHP
MCHX
MCI
MCK
MCO
MCR
MCRB
MCS
MCW
MCY
MD
MDB
MDC
MDGL
MDIA
MDLZ
MDRR
MDV
MDVL
MDWT
MDXG
ME
MEC
MED
MEDP
MEDS
MEG
MEI
MEIP
MEOA
MESA
META
METC
MFA
MFH
MFIC
MFIN
MFM
MFV
MG
MGEE
MGI
MGLD
MGM
MGNI
MGNX
MGPI
MGRC
MGTA
MGTX
MGY
MGYR
MHI
MHK
MHO
MIDD
MIGI
MIMO
MIN
MIND
MINDP
MINM
MIRM
MIRO
MITK
MITQ
MITT
MKC
MKC-V
MKFG
MKTW
MKTX
ML
MLAB
MLKN
MLNK
MLR
MLSS
MLYS
MMC
MMM
MMS
MMSI
MMT
MNKD
MNMD
MNOV
MNPR
MNRO
MNSB
MNST
MNTK
MNTN
MNTX
MOBQ
MOD
MODD
MODG
MODN
MODV
MOG-A
MOG-B
MOH
MONCU
MORF
MORN
MOS
MOTS
MOV
MOVE
MPAA
MPB
MPLN
MPRA
MPV
MPW
MPWR
MQ
MRAI
MRAM
MRBK
MRC
MRCC
MRCY
MRIN
MRKR
MRNS
MRO
MRSN
MRTN
MRTX
MRVI
MRVL
MSA
MSB
MSCI
MSEX
MSFT
MSGE
MSGM
MSGS
MSI
MSM
MSN
MSTR
MTAC
MTB
MTCR
MTD
MTEM
MTEX
MTH
MTN
MTNB
MTR
MTRN
MTRX
MTRY
MTSI
MTUS
MTZ
MU
MULN
MUSA
MVBF
MVIS
MVO
MWA
MXC
MXCT
MXL
MYE
MYFW
MYGN
MYMD
MYO
MYPS
MYRG
NABL
NAII
NAOV
NAPA
NARI
NATH
NATR
NAUT
NAVI
NBH
NBIX
NBN
NBSE
NBST
NBTB
NBY
NC
NCLH
NCMI
NCNO
NCPL
NCSM
NDAC
NDACU
NDLS
NDMO
NDRA
NDSN
NECB
NEE
NEN
NEO
NEOG
NEP
NEPH
NERV
NET
NETC
NEU
NEUE
NEWT
NEXI
NEXT
NFE
NFG
NFLX
NGL
NGM
NGS
NGVC
NGVT
NHC
NHI
NHICU
NI
NIC
NICK
NINE
NJR
NKE
NKLA
NKSH
NKTR
NKTX
NL
NLTX
NLY
NMFC
NMIH
NMRD
NMTC
NN
NNBR
NNI
NNN
NNVC
NOAC
NOACU
NOACW
NOC
NODK
NOG
NOTV
NOV
NOVA
NOVT
NOW
NPAB
NPCE
NPFD
NPK
NR
NRBO
NRC
NRDS
NRDY
NREF
NRG
NRGV
NRIM
NRIX
NRT
NRXP
NS
NSA
NSC
NSIT
NSP
NSSC
NSTB
NSTG
NSTS
NSYS
NTAP
NTCT
NTGR
NTIC
NTIP
NTLA
NTNX
NTRA
NTRB
NTRS
NTST
NTWK
NUBI
NUKK
NURO
NUS
NUTX
NUVB
NUVL
NUWE
NVAC
NVAX
NVCT
NVDA
NVEC
NVFY
NVIV
NVNO
NVR
NVRO
NVST
NVVE
NWE
NWFL
NWL
NWLI
NWN
NWPX
NWS
NWSA
NX
NXC
NXDT
NXGL
NXN
NXP
NXPL
NXRT
NXST
NXTC
NYC
NYCB
NYT
O
OABI
OB
OBIO
OBLG
OBT
OC
OCAX
OCAXU
OCC
OCCI
OCEA
OCFC
OCGN
OCN
OCSL
OCUL
OCUP
OCX
ODC
ODFL
ODP
OESX
OFG
OFIX
OFLX
OFS
OGE
OGN
OGS
OHAA
OHI
OHPA
OHPAU
OI
OIA
OII
OKE
OKLO
OKTA
OLB
OLLI
OLMA
OLN
OLO
OLP
OLPX
OMC
OMER
OMEX
OMF
OMGA
OMI
OMIC
OMQS
ON
ONB
ONCO
ONCT
ONEW
ONL
ONTF
ONTO
ONTX
ONVO
OPAD
OPBK
OPCH
OPEN
OPFI
OPGN
OPHC
OPI
OPK
OPOF
OPRT
OPRX
OPTN
OPTT
OPXS
OPY
ORA
ORC
ORCL
ORGN
ORGO
ORGS
ORIC
ORMP
ORN
ORRF
OSCR
OSG
OSI
OSIS
OSK
OSPN
OSS
OSUR
OTEC
OTIS
OTLK
OTRK
OTTR
OUST
OUT
OVBC
OVID
OVLY
OVV
OWLT
OXLC
OXLCM
OXLCO
OXM
OXSQ
OXY
OZ
OZK
PACI
PACK
PACW
PAG
PAHC
PALI
PALT
PANW
PAR
PARA
PARR
PASG
PATH
PATI
PATK
PAVM
PAY
PAYC
PAYO
PAYS
PAYX
PB
PBAX
PBBK
PBF
PBFS
PBH
PBI
PBLA
PBPB
PBT
PBYI
PCAR
PCB
PCG
PCH
PCRX
PCSA
PCT
PCTI
PCTY
PCVX
PCYO
PD
PDCO
PDEX
PDM
PDO
PDSB
PDYN
PEB
PEBK
PEBO
PECO
PEG
PEGA
PEGY
PEN
PENN
PEP
PEPG
PESI
PETQ
PETS
PETV
PEV
PFBC
PFC
PFG
PFGC
PFIE
PFIN
PFLT
PFMT
PFSI
PFX
PG
PGEN
PGNY
PGR
PGRE
PGTI
PGZ
PH
PHAT
PHD
PHIO
PHM
PHR
PHT
PHX
PI
PII
PIII
PIK
PIM
PINC
PINE
PINS
PIPR
PIRS
PIXY
PJT
PKBK
PKE
PKG
PKOH
PKST
PL
PLAB
PLAY
PLBC
PLBY
PLCE
PLD
PLL
PLMR
PLNT
PLOW
PLPC
PLRX
PLSE
PLTR
PLUG
PLUS
PLXS
PLYM
PM
PMCB
PMD
PMM
PMO
PMT
PMTS
PMVP
PNBK
PNM
PNNT
PNRG
PNT
PNTG
PNW
POAI
POL
POLA
POR
PORT
POST
POWI
POWL
POWW
PPC
PPG
PPIH
PPL
PPT
PPTA
PPYA
PR
PRA
PRAA
PRAX
PRCH
PRCT
PRDO
PRDS
PRFT
PRG
PRGS
PRIM
PRK
PRLD
PRME
PRMW
PRO
PROV
PRPH
PRPL
PRPO
PRSO
PRST
PRT
PRTC
PRTH
PRTS
PRU
PRVA
PSA
PSEC
PSMT
PSN
PSNL
PSTG
PSTL
PSTV
PSTX
PSX
PTC
PTCT
PTEN
PTIX
PTLO
PTMN
PTN
PTON
PTPI
PTRS
PTSI
PTVE
PUBM
PUCK
PUCKU
PULM
PUMP
PVBC
PVH
PVL
PWFL
PWOD
PWP
PWR
PWSC
PXD
PXLW
PXMD
PYCR
PYPL
PYXS
PZG
PZZA
QCOM
QCRH
QFTA
QLGN
QMCO
QNRX
QNST
QRHC
QRTEA
QRTEB
QRVO
QS
QSI
QTI
QTRX
QTWO
QUIK
QXO
R
RACY
RAIL
RAIN
RAMP
RAND
RANI
RAPT
RARE
RAVE
RBB
RBC
RBCAA
RBKB
RBLX
RBOT
RC
RCAC
RCACU
RCAT
RCEL
RCG
RCKT
RCKY
RCL
RCLFU
RCM
RCMT
RCRT
RCUS
RDDT
RDFN
RDI
RDIB
RDN
RDNT
RDUS
RDVT
RDW
REAX
REFI
REFR
REG
REGN
REI
REKR
RELI
RELL
RELY
RENB
RENT
REPL
REPX
REVB
REVG
REX
REXR
REYN
REZI
RFIL
RFL
RGCO
RGF
RGLD
RGLS
RGNX
RGP
RGR
RGS
RGT
RGTI
RH
RHE
RHI
RICK
RIGL
RILY
RILYL
RIOT
RITM
RIVN
RJF
RKDA
RKLB
RKT
RL
RLAY
RLGT
RLJ
RLMD
RLYB
RM
RMBI
RMBL
RMBS
RMCF
RMD
RMM
RMNI
RMR
RMT
RMTI
RNA
RNAC
RNAZ
RNGR
RNWK
RNXT
ROAD
ROC
ROCK
ROCL
ROG
ROIC
ROK
ROKU
ROL
ROOT
ROST
ROVR
RPAY
RPHM
RPID
RPM
RPRX
RRBI
RRC
RRGB
RRR
RSG
RSI
RSLS
RSSS
RSTN
RSVR
RTX
RUN
RVLV
RVMD
RVNC
RVP
RVPH
RVSB
RVT
RWAY
RWOD
RWT
RXDX
RXRX
RXST
RXT
RYAM
RYI
RYTM
RZLT
S
SABR
SABS
SACH
SAFE
SAFT
SAGA
SAGE
SAH
SAIA
SAIC
SALM
SAM
SAMAU
SAMG
SANA
SANM
SANW
SAR
SASI
SASR
SATS
SAVA
SAVE
SBAC
SBEV
SBFM
SBGI
SBH
SBOW
SBR
SBRA
SBSI
SBT
SBUX
SCAQU
SCHL
SCI
SCKT
SCM
SCMA
SCOR
SCPH
SCS
SCSC
SCTL
SCU
SCVL
SCWO
SCWX
SCX
SCYX
SD
SDACU
SDGR
SDIG
SDPI
SEAS
SEAT
SEB
SEE
SEEL
SEER
SEG
SEIC
SELF
SEMR
SENEA
SENEB
SENS
SERA
SES
SEVN
SF
SFBS
SFE
SFIX
SFM
SFNC
SFST
SG
SGA
SGBX
SGC
SGE
SGEN
SGH
SGHT
SGII
SGLY
SGMA
SGMO
SGRY
SGTX
SGU
SHBI
SHC
SHCR
SHEN
SHLS
SHOO
SHPW
SHW
SHYF
SIBN
SIEB
SIF
SIGA
SIGI
SILK
SINT
SIRI
SITC
SITE
SITM
SIX
SJM
SJT
SJW
SKIL
SKIN
SKWD
SKX
SKY
SKYE
SKYH
SKYT
SKYW
SLAB
SLAC
SLB
SLCA
SLDB
SLDP
SLG
SLGC
SLNG
SLNO
SLP
SLQT
SLRC
SLRX
SLS
SLVM
SMAR
SMBC
SMBK
SMFL
SMG
SMHI
SMID
SMLP
SMMF
SMP
SMPL
SMR
SMRT
SMSI
SMTC
SMTI
SN
SNA
SNAP
SNAX
SNBR
SNCE
SNCR
SNCY
SND
SNDA
SNDX
SNES
SNEX
SNFCA
SNGX
SNMP
SNOA
SNOW
SNPO
SNPS
SNPX
SNSE
SNTI
SNV
SNX
SOFO
SOHO
SOHOB
SOHON
SOHOO
SOI
SOLV
SONM
SONN
SONO
SONX
SOR
SOTK
SOUN
SOVO
SOWG
SP
SPB
SPCE
SPGC
SPGI
SPH
SPI
SPIR
SPLK
SPLP
SPOK
SPPI
SPR
SPRB
SPRO
SPRY
SPSC
SPT
SPTK
SPTN
SPWH
SPXC
SQFT
SQL
SQSP
SR
SRC
SRCE
SRCL
SRDX
SRE
SRI
SRPT
SRRK
SRT
SRTS
SRZN
SSB
SSBI
SSBK
SSIC
SSKN
SSNT
SSP
SSRM
SSSS
SSTK
SSY
SSYS
STAF
STAG
STBA
STC
STCN
STE
STEM
STEP
STER
STEW
STGW
STIM
STKL
STKS
STOK
STR
STRA
STRL
STRM
STRO
STRR
STRS
STRT
STSS
STT
STTK
STWD
STXS
STZ
STZ-B
SUAC
SUI
SUM
SUN
SUNW
SUP
SUPN
SURF
SURG
SVC
SVRA
SVT
SWAV
SWBI
SWET
SWETU
SWI
SWIM
SWK
SWKH
SWKS
SWN
SWSS
SWTX
SWX
SXI
SXT
SYBT
SYBX
SYF
SYK
SYM
SYNA
SYPR
SYRS
SYY
SZZL
T
TACT
TAIT
TAP
TAP-A
TARA
TARS
TASK
TAST
TAYD
TBCP
TBCPU
TBI
TBNK
TBPH
TCBC
TCBI
TCBK
TCBS
TCBX
TCDA
TCI
TCMD
TCOA
TCON
TCPC
TCRT
TCRX
TCS
TDG
TDOC
TDUP
TDW
TECH
TELA
TELL
TENX
TER
TERN
TEX
TFFP
TFSL
TFX
TG
TGAN
TGI
TGNA
TGT
TGVC
TH
THC
THCP
THFF
THG
THMO
THO
THR
THRD
THRM
THRX
THS
TIL
TILE
TIPT
TISI
TIVC
TJX
TKNO
TKO
TKR
TLF
TLIS
TLS
TLSI
TLYS
TMAC
TMBR
TMCI
TMDX
TMHC
TMO
TMP
TMUS
TNC
TNDM
TNET
TNGX
TNL
TNON
TNXP
TNYA
TOI
TOL
TOWN
TPB
TPC
TPCS
TPET
TPG
TPHS
TPL
TPR
TPST
TPVG
TR
TRAK
TRC
TRDA
TREE
TREX
TRGP
TRIN
TRIP
TRMK
TRN
TRNO
TRNS
TROW
TROX
TRS
TRST
TRT
TRTX
TRU
TRUE
TRV
TRVI
TRVN
TSBK
TSCO
TSHA
TSIB
TSIBU
TSLA
TSLX
TSN
TSQ
TSRI
TSVT
TTC
TTEC
TTEK
TTGT
TTI
TTMI
TTNP
TTOO
TTSH
TTWO
TUP
TURN
TUSK
TW
TWCB
TWI
TWIN
TWKS
TWLV
TWLVU
TWO
TWOU
TWST
TXG
TXMD
TXN
TXRH
TXT
TY
TYG
TYL
TYRA
TZOO
UA
UAA
UAMY
UAN
UBCP
UBER
UBSI
UBX
UCBI
UCTT
UDMY
UDR
UE
UEC
UFCS
UFI
UFPI
UFPT
UG
UGI
UHAL
UHS
UHT
UI
ULBI
ULCC
ULH
ULTA
UMH
UNB
UNCY
UNF
UNFI
UNM
UNP
UNTY
UONE
UONEK
UP
UPH
UPS
UPST
UPWK
URBN
URG
URGN
URI
USAC
USAP
USAU
USB
USCB
USEG
USFD
USIO
USLM
USNA
USPH
USX
UTHR
UTI
UTL
UTMD
UTRS
UTZ
UUU
UUUU
UVE
UVSP
UVV
UWMC
V
VABK
VAC
VALU
VAPO
VAXX
VBFC
VBIV
VC
VCEL
VCNX
VCSA
VCV
VCYT
VECO
VEEE
VEEV
VEL
VERA
VERB
VERBW
VERI
VERU
VERV
VERX
VERY
VFC
VFL
VGAS
VGM
VGR
VGZ
VHAQ
VHC
VHI
VIA
VIAV
VICI
VIEW
VIGL
VII
VIIAU
VINC
VINE
VINO
VIR
VIRC
VIRI
VIRX
VITL
VIVK
VKI
VKQ
VKTX
VLCN
VLD
VLGEA
VLO
VLT
VMC
VMD
VMEO
VMGA
VMI
VMO
VMW
VNCE
VNDA
VNO
VNOM
VNRX
VNT
VOC
VOR
VOXX
VPV
VRA
VRAR
VRCA
VRDN
VRE
VREX
VRM
VRNS
VRNT
VRRM
VRSK
VRSN
VRT
VRTV
VRTX
VSAC
VSAT
VSCO
VSEC
VSH
VST
VSTM
VSTO
VTGN
VTN
VTNR
VTOL
VTR
VTRS
VTVT
VTYX
VUZI
VVI
VVV
VVX
VWE
VXRT
VYGR
VYNE
VYX
VZ
VZIO
W
WAB
WABC
WAFD
WAL
WASH
WATT
WAVD
WAVS
WBA
WBD
WBS
WCC
WDAY
WDC
WDFC
WEAV
WELL
WERN
WES
WEX
WEYS
WGO
WH
WHD
WHF
WHLM
WHLR
WHLRD
WHLRP
WHR
WING
WINT
WINV
WIRE
WISA
WK
WKHS
WKSP
WLDN
WLFC
WLK
WLKP
WLY
WLYB
WM
WMC
WMG
WMK
WMPN
WMS
WNC
WOLF
WOOF
WOR
WPC
WRAC
WRB
WRBY
WRK
WRLD
WS
WSBC
WSBF
WSC
WSFS
WSM
WSR
WST
WTBA
WTER
WTI
WTMA
WTRE
WTRG
WTS
WTTR
WU
WULF
WVVI
WVVIP
WW
WWD
WWR
WWW
WY
WYNN
WYY
X
XAIR
XBIO
XBIT
XCUR
XEL
XELA
XERS
XFIN
XFLT
XFOR
XGN
XHR
XLO
XM
XMTR
XNCR
XOM
XOMA
XOS
XPDB
XPEL
XPL
XPO
XPOF
XPON
XRAY
XTNT
XXII
XYL
YCBD
YEXT
YMAB
YORW
YOU
YTEN
YUM
Z
ZBRA
ZD
ZDGE
ZETA
ZFOX
ZG
ZIMV
ZIP
ZIVO
ZM
ZNTL
ZOM
ZS
ZTS
ZUMZ
ZUO
ZVIA
ZWS
ZYME
ZYNE
ZYXI


================================================
File: upload.ts
================================================
import Database from "./src/services/databases/mongo";
import StockFinancials from "./src/models/StockFinancials";

class EarningsProcessor {
  private static getTickersFromCsv(): string[] {
    const fs = require("fs");
    const csvContent = fs.readFileSync("tickers.csv", "utf-8");
    return csvContent
      .split("\n")
      .slice(1) // Skip header row
      .map((line) => line.trim()) // Get ticker from line
      .filter((ticker) => ticker && ticker.length > 0); // Remove empty lines
  }

  async processAndSaveEarningsForOneStock(ticker: string) {
    await StockFinancials.downloadFinancials(ticker);
  }

  async processAndSaveEarningsForAllStocks() {
    const tickers = EarningsProcessor.getTickersFromCsv();
    await StockFinancials.downloadFinancialsForTickerList(tickers);
  }

  async updateAllFinancials() {
    const tickers = EarningsProcessor.getTickersFromCsv();
    await StockFinancials.downloadFinancialsForTickerList(tickers);
  }
}

(async () => {
  try {
    const cloud = new Database("local");
    await cloud.connect();
    console.log("Connected to database");
    const startTime = new Date();
    const processor = new EarningsProcessor();
    await processor.processAndSaveEarningsForAllStocks();
    const endTime = new Date();
    const duration = endTime.getTime() - startTime.getTime();
    console.log(
      `Processing complete. Files have been saved. Time taken: ${duration}ms`
    );
  } catch (error) {
    console.error("Error:", error);
  } finally {
    process.exit(0);
  }
})();


================================================
File: src/models/StockFinancials.ts
================================================
import {
  EodhdBulkFundamentalsResponse,
  EodhdClient,
} from "../services/fundamentalApi/EodhdClient";
import { Schema, model } from "mongoose";

import { FinancialsDataManager } from "../services/databases/bigQuery";
import momentTz from "moment-timezone";

// Batch size for processing stocks in groups
const BATCH_SIZE = 10;

// Define the interface with required fields
export interface IStockFinancials {
  date: Date;
  ticker: string;
  symbol: string;
  [key: string]: any; // Allow any additional fields
}

class NoFinancialsError extends Error {
  constructor() {
    super("Earnings don't exist");
  }
}
class EtfError extends Error {
  constructor() {
    super("ETF data exists");
  }
}

// Schema definition with required fields
const baseSchema = {
  date: { type: Date, required: true },
  ticker: { type: String, required: true },
  symbol: { type: String, required: true },
};

const schemaOptions = {
  strict: false, // Allow additional fields not specified in schema
};

const QuarterlyFinancialsSchema = new Schema<IStockFinancials>(
  baseSchema,
  schemaOptions
);
const AnnualFinancialsSchema = new Schema<IStockFinancials>(
  baseSchema,
  schemaOptions
);

// Create compound indexes for efficient lookups
QuarterlyFinancialsSchema.index({ ticker: 1, date: 1 }, { unique: true });
AnnualFinancialsSchema.index({ ticker: 1, date: 1 }, { unique: true });

const QuarterlyFinancialsModel = model<IStockFinancials>(
  "StockQuarterlyFinancials",
  QuarterlyFinancialsSchema
);
const AnnualFinancialsModel = model<IStockFinancials>(
  "StockAnnualFinancials",
  AnnualFinancialsSchema
);

// Meta model to track last download timestamp
export interface IStockFinancialsMeta {
  _id: string;
  lastDownload: Date;
}

export default class StockFinancials {
  private static getClose(datestring: string | Date) {
    return momentTz
      .tz(datestring, "America/New_York")
      .set({ hour: 16, minute: 0, second: 0, millisecond: 0 })
      .utc()
      .toDate();
  }

  private static processFinancialData(
    ticker: string,
    dictKey: string,
    details: any
  ) {
    return {
      ...details,
      ticker,
      symbol: ticker,
      date: this.getClose(details?.filing_date || dictKey),
      filing_date: undefined,
    };
  }

  // Only allow strictly numeric fields (plus the three required).
  private static generateBigQuerySchema(data: any[]) {
    const requiredFields = [
      { name: "ticker", type: "STRING" },
      { name: "symbol", type: "STRING" },
      { name: "date", type: "TIMESTAMP" },
    ];
    const numericFields = new Set<string>();

    data.forEach((item) => {
      for (const [key, value] of Object.entries(item)) {
        if (!["ticker", "symbol", "date"].includes(key)) {
          // Only add this key if it's truly a number
          if (typeof value === "number") {
            numericFields.add(key);
          }
        }
      }
    });

    const schema = [...requiredFields];
    for (const field of numericFields) {
      schema.push({ name: field, type: "FLOAT64" });
    }

    return schema;
  }

  // Filter a record so that it only contains keys defined in the schema.
  private static filterRecordForBQ(
    record: IStockFinancials,
    schema: { name: string; type: string }[]
  ): any {
    const allowedFields = new Set(schema.map((field) => field.name));
    const filtered: any = {};
    for (const key of Object.keys(record)) {
      if (allowedFields.has(key)) {
        filtered[key] = record[key];
      }
    }
    return filtered;
  }

  private static async fetchFinancials(
    ticker: string
  ): Promise<{ quarterly: IStockFinancials[]; annual: IStockFinancials[] }> {
    console.log(`Downloading financials for ${ticker}...`);
    const client = new EodhdClient();

    const fundamentals = await client.getFundamentals(ticker);
    if (!fundamentals) {
      throw new NoFinancialsError();
    }
    if (fundamentals.ETF_Data || fundamentals.General?.Type === "ETF") {
      throw new EtfError();
    }
    if (
      !fundamentals.General?.Address ||
      !fundamentals.General.Address.includes("United States")
    ) {
      throw new Error("Non-US or missing address");
    }
    if (Object.keys(fundamentals.Financials || {}).length === 0) {
      throw new NoFinancialsError();
    }

    // Check if any of the financial statements use non-USD currency
    const currencySymbols = [
      fundamentals.Financials?.Balance_Sheet?.currency_symbol,
      fundamentals.Financials?.Cash_Flow?.currency_symbol,
      fundamentals.Financials?.Income_Statement?.currency_symbol,
    ];

    if (currencySymbols.some((symbol) => symbol && symbol !== "USD")) {
      throw new Error("Non-USD currency detected");
    }

    const quarterlyMap = new Map<string, any>();
    const annualMap = new Map<string, any>();

    const quarterlyData = {
      Balance_Sheet: fundamentals?.Financials?.Balance_Sheet?.quarterly || {},
      Cash_Flow: fundamentals?.Financials?.Cash_Flow?.quarterly || {},
      Income_Statement:
        fundamentals?.Financials?.Income_Statement?.quarterly || {},
    };

    Object.values(quarterlyData).forEach((statementObj) => {
      if (!statementObj) return;
      Object.entries(statementObj).forEach(([dictKey, details]) => {
        const record = this.processFinancialData(ticker, dictKey, details);
        const key = record.date.toISOString();
        this.mergeRecord(quarterlyMap, key, record);
      });
    });

    const yearlyData = {
      Balance_Sheet: fundamentals?.Financials?.Balance_Sheet?.yearly || {},
      Cash_Flow: fundamentals?.Financials?.Cash_Flow?.yearly || {},
      Income_Statement:
        fundamentals?.Financials?.Income_Statement?.yearly || {},
    };

    Object.values(yearlyData).forEach((statementObj) => {
      if (!statementObj) return;
      Object.entries(statementObj).forEach(([dictKey, details]) => {
        const record = this.processFinancialData(ticker, dictKey, details);
        const key = record.date.toISOString();
        this.mergeRecord(annualMap, key, record);
      });
    });

    return {
      quarterly: Array.from(quarterlyMap.values()),
      annual: Array.from(annualMap.values()),
    };
  }

  private static async updateDatabaseAndBQ(
    quarterly: IStockFinancials[],
    annual: IStockFinancials[]
  ) {
    // 1. Update MongoDB (store full records).
    const bulkOpsQuarterly = quarterly.map((doc) => ({
      updateOne: {
        filter: { ticker: doc.ticker, date: doc.date },
        update: doc,
        upsert: true,
      },
    }));
    const bulkOpsAnnual = annual.map((doc) => ({
      updateOne: {
        filter: { ticker: doc.ticker, date: doc.date },
        update: doc,
        upsert: true,
      },
    }));

    if (bulkOpsQuarterly.length > 0) {
      await QuarterlyFinancialsModel.bulkWrite(bulkOpsQuarterly);
    }
    if (bulkOpsAnnual.length > 0) {
      await AnnualFinancialsModel.bulkWrite(bulkOpsAnnual);
    }

    // 2. Update BigQuery with only numeric fields + required fields
    try {
      if (quarterly.length > 0) {
        const quarterlySchema = this.generateBigQuerySchema(quarterly);
        const quarterlyBQ = await FinancialsDataManager.createQuarterlyTable(
          quarterlySchema
        );
        const filteredQuarterly = quarterly.map((record) =>
          this.filterRecordForBQ(record, quarterlySchema)
        );
        await quarterlyBQ.insertFinancialsToTempTable(filteredQuarterly);
        await quarterlyBQ.mergeTempTableToMainTable();
        console.log("Quarterly financials uploaded to BigQuery successfully");
      }

      if (annual.length > 0) {
        const annualSchema = this.generateBigQuerySchema(annual);
        const annualBQ = await FinancialsDataManager.createAnnualTable(
          annualSchema
        );
        const filteredAnnual = annual.map((record) =>
          this.filterRecordForBQ(record, annualSchema)
        );
        await annualBQ.insertFinancialsToTempTable(filteredAnnual);
        await annualBQ.mergeTempTableToMainTable();
        console.log("Annual financials uploaded to BigQuery successfully");
      }
    } catch (error) {
      console.error("Error uploading to BigQuery:", error);
      console.log(error?.errors?.[0]);
    }
  }

  // downloadFinancials for single ticker
  public static async downloadFinancials(ticker: string): Promise<{
    quarterly: IStockFinancials[];
    annual: IStockFinancials[];
  }> {
    const { quarterly, annual } = await this.fetchFinancials(ticker);
    await this.updateDatabaseAndBQ(quarterly, annual);
    return { quarterly, annual };
  }

  private static mergeRecord(
    map: Map<string, any>,
    key: string | undefined,
    newData: any
  ) {
    if (!key) return;
    const existing = map.get(key) || {};
    map.set(key, { ...existing, ...newData });
  }

  // New method to process tickers in bulk
  public static async downloadFinancialsForTickerList(tickers: string[]) {
    const client = new EodhdClient();
    const batchSize = 500; // Bulk API limit
    console.log("Total stocks to process:", tickers.length);
    const totalBatches = Math.ceil(tickers.length / batchSize);

    for (let i = 0; i < tickers.length; i += batchSize) {
      const currentBatch = Math.floor(i / batchSize) + 1;
      console.log(`Processing Batch ${currentBatch}/${totalBatches}`);
      const batch = tickers.slice(i, i + batchSize);
      const batchQuarterly: IStockFinancials[] = [];
      const batchAnnual: IStockFinancials[] = [];

      try {
        const bulkData: EodhdBulkFundamentalsResponse[] =
          await client.getBulkFundamentals("US", batch, 0, batchSize);

        for (const fundamentals of bulkData) {
          const ticker = fundamentals.General?.Code;
          if (!ticker) continue;
          if (fundamentals.ETF_Data || fundamentals.General?.Type === "ETF")
            continue;
          if (
            !fundamentals.General?.Address ||
            !fundamentals.General.Address.includes("United States")
          )
            continue;
          if (
            !fundamentals.Financials ||
            Object.keys(fundamentals.Financials).length === 0
          )
            continue;

          try {
            const { quarterly, annual } = this.processBulkFinancialData(
              ticker,
              fundamentals
            );
            batchQuarterly.push(...quarterly);
            batchAnnual.push(...annual);
            console.log(`Processed ${ticker} successfully`);
          } catch (error) {
            console.error(`Error processing ${ticker}:`, error);
          }
        }

        if (batchQuarterly.length > 0 || batchAnnual.length > 0) {
          await this.updateDatabaseAndBQ(batchQuarterly, batchAnnual);
          console.log(`Batch ${currentBatch} uploaded successfully`);
        }

        // Add a small delay between batches to avoid rate limiting
        if (currentBatch < totalBatches) {
          await new Promise((resolve) => setTimeout(resolve, 1000));
        }
      } catch (error) {
        console.error(
          `Error fetching bulk fundamentals for batch ${batch.join(", ")}:`,
          error
        );
      }
    }
  }

  // Add this new helper method to process bulk fundamentals data
  private static processBulkFinancialData(
    ticker: string,
    fundamentals: EodhdBulkFundamentalsResponse
  ): { quarterly: IStockFinancials[]; annual: IStockFinancials[] } {
    if (fundamentals.ETF_Data || fundamentals.General?.Type === "ETF") {
      throw new EtfError();
    }
    if (
      !fundamentals.General?.Address ||
      !fundamentals.General.Address.includes("United States")
    ) {
      throw new Error("Non-US or missing address");
    }
    if (
      !fundamentals.Financials ||
      Object.keys(fundamentals.Financials).length === 0
    ) {
      throw new NoFinancialsError();
    }

    // Check currency symbols for all financial statements
    const currencySymbols = [
      fundamentals.Financials.Balance_Sheet?.currency_symbol,
      fundamentals.Financials.Cash_Flow?.currency_symbol,
      fundamentals.Financials.Income_Statement?.currency_symbol,
    ];

    if (currencySymbols.some((symbol) => symbol && symbol !== "USD")) {
      throw new Error("Non-USD currency detected");
    }

    const quarterlyMap = new Map<string, any>();
    const annualMap = new Map<string, any>();
    const financialStatements = [
      "Balance_Sheet",
      "Cash_Flow",
      "Income_Statement",
    ];

    financialStatements.forEach((statement) => {
      const stmtData = fundamentals.Financials?.[statement];
      if (stmtData) {
        // Process quarterly data
        [
          "quarterly_last_0",
          "quarterly_last_1",
          "quarterly_last_2",
          "quarterly_last_3",
        ].forEach((key) => {
          if (stmtData[key]) {
            const record = this.processFinancialData(
              ticker,
              key,
              stmtData[key]
            );
            this.mergeRecord(quarterlyMap, record.date.toISOString(), record);
          }
        });
        // Process yearly data
        [
          "yearly_last_0",
          "yearly_last_1",
          "yearly_last_2",
          "yearly_last_3",
        ].forEach((key) => {
          if (stmtData[key]) {
            const record = this.processFinancialData(
              ticker,
              key,
              stmtData[key]
            );
            this.mergeRecord(annualMap, record.date.toISOString(), record);
          }
        });
      }
    });

    return {
      quarterly: Array.from(quarterlyMap.values()),
      annual: Array.from(annualMap.values()),
    };
  }
}


================================================
File: src/services/databases/bigQuery.ts
================================================
import { BigQuery } from "@google-cloud/bigquery";
import moment from "moment";

export class FinancialsDataManager {
  private bigquery: BigQuery;
  private dataset: string;
  private table: string;
  private tempTable: string;
  static readonly quarterlyTableId = "quarterly";
  static readonly annualTableId = "annual";
  static readonly datasetId = "financials";

  constructor(table: string) {
    const credentials = this.setupCredentials();
    this.bigquery = new BigQuery({ credentials });
    this.dataset = FinancialsDataManager.datasetId;
    this.table = table;
    this.tempTable = `${table}_temp_${Date.now()}`;
  }

  private setupCredentials() {
    const credentialsJson = process.env.GOOGLE_APPLICATION_CREDENTIALS_JSON;
    if (!credentialsJson) {
      throw new Error(
        "GOOGLE_APPLICATION_CREDENTIALS_JSON environment variable is not set"
      );
    }
    try {
      return JSON.parse(credentialsJson);
    } catch (error) {
      throw new Error("Failed to parse GOOGLE_APPLICATION_CREDENTIALS_JSON");
    }
  }

  static async createQuarterlyTable(schema: any[]) {
    const instance = new FinancialsDataManager(this.quarterlyTableId);
    await instance.createTableIfNotExists(schema);
    await instance.createTempTable(schema);
    return instance;
  }

  static async createAnnualTable(schema: any[]) {
    const instance = new FinancialsDataManager(this.annualTableId);
    await instance.createTableIfNotExists(schema);
    await instance.createTempTable(schema);
    return instance;
  }

  private async createTable(tableName: string, schema?: any[]) {
    try {
      const dataset = this.bigquery.dataset(this.dataset);
      const table = dataset.table(tableName);

      let [exists] = await table.exists();
      let iterations = 0;

      while (!exists && iterations < 3) {
        if (iterations === 0 && schema) {
          await table.create({ schema });
          console.log(`Created table ${tableName} with schema`);
        }
        iterations++;
        [exists] = await table.exists();
        await new Promise((resolve) =>
          setTimeout(resolve, 2 ** iterations * 1000)
        );
      }
    } catch (error) {
      console.error(`Error creating table ${tableName}:`, error);
      throw error;
    }
  }

  private async createTableIfNotExists(schema: any[]) {
    await this.createTable(this.table, schema);
  }

  private async createTempTable(schema: any[]) {
    await this.createTable(this.tempTable, schema);
  }

  private filterNumericFields(data: any) {
    const requiredFields = ["ticker", "symbol", "date"];
    const filtered: any = {};

    Object.entries(data).forEach(([key, value]) => {
      if (requiredFields.includes(key)) {
        filtered[key] = value;
      } else if (typeof value === "number" || !isNaN(Number(value))) {
        // Only include numeric values
        filtered[key] = Number(value);
      }
    });

    return filtered;
  }

  async insertFinancialsToTempTable(financials: any[]): Promise<void> {
    try {
      if (!financials.length) {
        console.log("No financial data to upsert");
        return;
      }

      const dataset = this.bigquery.dataset(this.dataset);
      const table = dataset.table(this.tempTable);

      const rows = financials.map((item) => ({
        ...this.filterNumericFields(item),
        date: BigQuery.timestamp(
          moment(item.date).format("YYYY-MM-DD HH:mm:ss.SSSZ")
        ),
      }));

      const batchSize = 500;
      for (let i = 0; i < rows.length; i += batchSize) {
        const batch = rows.slice(i, i + batchSize);
        await table.insert(batch);
        console.log(`Inserted batch of ${batch.length} financial rows.`);
      }
    } catch (error) {
      console.error("Error inserting financials to temp table:", error);
      throw error;
    }
  }

  async mergeTempTableToMainTable(): Promise<void> {
    try {
      // Get column names from a sample row
      const [sampleRow] = await this.bigquery.query({
        query: `SELECT * FROM \`${this.dataset}.${this.tempTable}\` LIMIT 1`,
      });

      const columns = Object.keys(sampleRow[0] || {});
      const columnList = columns.join(", ");

      const mergeQuery = `
          MERGE \`${this.dataset}.${this.table}\` T
          USING \`${this.dataset}.${this.tempTable}\` S
          ON T.ticker = S.ticker AND T.date = S.date
          WHEN MATCHED THEN
            UPDATE SET ${columns.map((col) => `T.${col} = S.${col}`).join(", ")}
          WHEN NOT MATCHED THEN
            INSERT (${columnList})
            VALUES (${columns.map((col) => `S.${col}`).join(", ")})
        `;

      await this.bigquery.query({ query: mergeQuery });
      console.log("Merged temp financials table into main table successfully.");
    } catch (error) {
      console.error("Error merging temp financials into main table:", error);
      throw error;
    } finally {
      // Always attempt to drop the temp table
      try {
        const dropTempTableQuery = `
            DROP TABLE IF EXISTS \`${this.dataset}.${this.tempTable}\`
          `;
        await this.bigquery.query({ query: dropTempTableQuery });
        console.log("Dropped temporary financials table successfully.");
      } catch (dropError) {
        console.error("Error dropping temp table:", dropError);
      }
    }
  }

  async executeQuery(query: string): Promise<any[]> {
    try {
      const options = {
        query: query,
        location: "US",
      };
      const [job] = await this.bigquery.createQueryJob(options);
      console.log(`Job ${job.id} started.`);
      const [rows] = await job.getQueryResults();

      return rows;
    } catch (error) {
      console.error("Error executing BigQuery:", query);
      console.error(error);
      throw error;
    }
  }
}


================================================
File: src/services/databases/mongo.ts
================================================
import { MongoClient } from "mongodb";
import dotenv from "dotenv";
import mongoose from "mongoose";

dotenv.config({ path: ".env" });

const cloudDB = process.env.CLOUD_DB;
const localDB = process.env.LOCAL_DB;
const connectionMap = new Map();
connectionMap.set("cloudDB", cloudDB);
connectionMap.set("cloud", cloudDB);
connectionMap.set("localDB", localDB);
connectionMap.set("local", localDB);

mongoose.set("strictQuery", false);

class Database {
  private dbType: string;
  private testDbInstance: any;
  private mongoClient: MongoClient | null = null;

  constructor(dbType: "local" | "cloud" | "test") {
    if (!dbType) throw new Error("No database type provided");
    this.dbType = dbType;
  }

  getMongoClient() {
    return this.mongoClient;
  }

  private async connectHelper() {
    const connectionURL = connectionMap.get(this.dbType);
    await mongoose.connect(connectionURL);
    this.mongoClient = new MongoClient(connectionURL);
    await this.mongoClient.connect();
    console.log(
      "Successfully connected to " + this.dbType + " database server!"
    );
  }

  private async connectTest() {
    const { MongoMemoryServer } = require("mongodb-memory-server");
    this.testDbInstance = new MongoMemoryServer();
    await this.testDbInstance.start();
    const uri = this.testDbInstance.getUri();
    await mongoose.connect(uri);
  }

  public async connect() {
    if (this.dbType === "cloud" || this.dbType === "local") {
      await this.connectHelper();
    } else if (this.dbType === "test") {
      await this.connectTest();
    }
  }

  public async disconnect() {
    if (this.dbType === "cloud" || this.dbType === "local") {
      if (this.mongoClient) await this.mongoClient.close();
      await mongoose.connection.close();
    } else if (this.dbType === "test") {
      await mongoose.connection.dropDatabase();
      await mongoose.connection.close();
      await this.testDbInstance.stop();
    }
  }

  public async clearDatabase() {
    if (!this.dbType || this.dbType === "cloud" || this.dbType === "local") {
      throw new Error("Not Implemented");
    } else if (this.dbType === "test") {
      const collections = mongoose.connection.collections;
      for (const key in collections) {
        const collection = collections[key];
        await collection.deleteMany({});
      }
    }
  }

  public async killLongRunningQueries(thresholdSeconds: number) {
    if (!this.mongoClient) {
      throw new Error("MongoClient is not connected");
    }

    const adminDb = this.mongoClient.db().admin();
    const currentOps = await adminDb.command({ currentOp: 1 });

    const longRunningOps = currentOps.inprog.filter((op: any) => {
      return op.secs_running > thresholdSeconds && op.op === "query";
    });

    for (const op of longRunningOps) {
      try {
        await adminDb.command({ killOp: 1, op: op.opid });
        console.log(`Killed long-running operation: ${op.opid}`);
      } catch (error: any) {
        console.error(`Failed to kill operation ${op.opid}: ${error.message}`);
      }
    }

    console.log(
      `Checked for long-running queries exceeding ${thresholdSeconds} seconds.`
    );
  }

  public async getLongRunningQueriesDetails(thresholdSeconds: number) {
    if (!this.mongoClient) {
      throw new Error("MongoClient is not connected");
    }

    const adminDb = this.mongoClient.db().admin();
    const currentOps = await adminDb.command({ currentOp: 1 });

    const longRunningOps = currentOps.inprog.filter((op: any) => {
      return op.secs_running > thresholdSeconds && op.op === "query";
    });

    return longRunningOps.map((op: any) => ({
      operationId: op.opid,
      namespace: op.ns,
      description: op.desc,
      client: op.client,
      appName: op.appName,
      duration: op.secs_running,
      planSummary: op.planSummary,
      query: op.command,
      lockStats: op.lockStats,
      waitingForLock: op.waitingForLock,
      numYields: op.numYields,
      threadId: op.threadId,
    }));
  }
}

export default Database;


================================================
File: src/services/fundamentalApi/EodhdClient.ts
================================================
import axios, { AxiosInstance } from "axios";

type Year = `${number}${number}${number}${number}`;
type Month = `${number}${number}`;
type Day = `${number}${number}`;
type Datestring = `${Year}-${Month}-${Day}`;

interface FinancialStatement {
  currency_symbol?: string;
  quarterly_last_0?: Record<string, any>;
  quarterly_last_1?: Record<string, any>;
  quarterly_last_2?: Record<string, any>;
  quarterly_last_3?: Record<string, any>;
  yearly_last_0?: Record<string, any>;
  yearly_last_1?: Record<string, any>;
  yearly_last_2?: Record<string, any>;
  yearly_last_3?: Record<string, any>;
}

interface HistoricalFinancialStatement {
  quarterly?: Record<Datestring, any>;
  yearly?: Record<Datestring, any>;
  currency_symbol?: string;
}

export interface EodhdBulkFundamentalsResponse {
  ETF_Data?: Record<string, any>;
  General?: {
    Address?: string;
    Code?: string;
    CUSIP?: string;
    Type?: string;
    Name?: string;
    Exchange?: string;
    CurrencyCode?: string;
  };
  Highlights?: {
    MarketCapitalization?: number;
    [key: string]: any;
  };
  Valuation?: Record<string, any>;
  SharesStats?: Record<string, any>;
  Technicals?: Record<string, any>;
  SplitsDividends?: Record<string, any>;
  AnalystRatings?: Record<string, any>;
  Earnings?: Record<string, any>;
  Financials?: {
    Balance_Sheet?: FinancialStatement;
    Cash_Flow?: FinancialStatement;
    Income_Statement?: FinancialStatement;
  };
}

export interface EodhdFundamentalsResponse {
  ETF_Data?: {
    Holdings?: Record<string, { Code: string; "Assets_%": number }>;
  };
  General?: {
    Code?: string;
    CUSIP?: string;
    Type?: string;
    Name?: string;
    Exchange?: string;
    CurrencyCode?: string;
    Address?: string;
  };
  Earnings?: {
    History?: any[];
    Annual?: any[];
  };
  Financials?: {
    Balance_Sheet?: HistoricalFinancialStatement;
    Cash_Flow?: HistoricalFinancialStatement;
    Income_Statement?: HistoricalFinancialStatement;
  };
}

export class EodhdClient {
  private readonly baseUrl: string = "https://eodhd.com/api";
  private readonly apiToken: string;
  private readonly client: AxiosInstance;

  constructor(apiToken: string = process.env.EOD_API_TOKEN!) {
    this.apiToken = apiToken;
    this.client = axios.create({
      baseURL: this.baseUrl,
      params: {
        api_token: this.apiToken,
        fmt: "json",
      },
    });
  }

  private buildUrl(endpoint: string): string {
    return `${endpoint}`;
  }

  async getFundamentals(ticker: string): Promise<EodhdFundamentalsResponse> {
    try {
      const url = this.buildUrl(`/fundamentals/${ticker}.US`);
      const { data } = await this.client.get(url);
      return data;
    } catch (error) {
      if (axios.isAxiosError(error)) {
        throw new Error(`Failed to fetch data for ${ticker}: ${error.message}`);
      }
      throw error;
    }
  }

  async getBulkFundamentals(
    exchange: string,
    symbols: string[],
    offset?: number,
    limit: number = 500
  ): Promise<EodhdBulkFundamentalsResponse[]> {
    try {
      const symbolsParam = symbols.map((s) => `${s}.US`).join(",");
      const url = this.buildUrl(`/bulk-fundamentals/${exchange}`);
      const { data } = await this.client.get(url, {
        params: {
          symbols: symbolsParam,
          offset,
          limit,
          version: "1.2",
        },
      });
      console.log(data);
      return data;
    } catch (error) {
      console.error(error);
      throw error;
    }
  }
}


================================================
File: src/services/llmApi/clients/OllamaServiceClient.ts
================================================
import { ChatMessage, SendChatMessageRequest } from "./RequestyServiceClient";
import OllamaChatLog, {
  OllamaChatRequest,
  OllamaChatResponse,
} from "../logs/ollamaChatLogs";

import axios from "axios";
import dotenv from "dotenv";

dotenv.config();

export enum OllamaModelEnum {
  deepseekR1 = "deepseek-r1:32b",
  llama3 = "llama3.3:latest",
  deepscaler = "deepscaler",
}

class OllamaServiceClient {
  baseUrl: string;

  constructor() {
    const ollamaUrl = process.env.OLLAMA_SERVICE_URL;
    if (!ollamaUrl) {
      throw new Error("OLLAMA_SERVICE_URL environment variable is not set");
    }
    this.baseUrl = `${ollamaUrl}/api/chat`;
  }

  private transformSenderToRole(message: ChatMessage) {
    const sender = message.sender.toLowerCase().trim();
    const role =
      sender === "ai assistant" || sender === "assistant"
        ? "assistant"
        : sender === "system"
        ? "system"
        : "user";
    return { role, content: message?.content || "" };
  }

  getChatResponseContent(response: OllamaChatResponse) {
    return response.message.content;
  }

  getModel() {
    return OllamaModelEnum.deepseekR1;
  }

  async sendRequest(
    request: SendChatMessageRequest
  ): Promise<OllamaChatResponse> {
    const { systemPrompt, messages, model } = request;

    const formattedMessages = [
      { sender: "System" as const, content: systemPrompt },
      ...messages,
    ].map((msg) => this.transformSenderToRole(msg));

    const chatRequest: OllamaChatRequest = {
      model,
      messages: formattedMessages,
      stream: false,
      options: {
        num_ctx: 32768,
      },
    };

    try {
      const response = await axios.post<OllamaChatResponse>(
        this.baseUrl,
        chatRequest
      );

      await OllamaChatLog.logChat(chatRequest, response.data, null);
      return response.data;
    } catch (error: any) {
      await OllamaChatLog.logChat(chatRequest, null, error.message);
      throw new Error(`Error in chat function: ${error.message}`);
    }
  }
}

export default OllamaServiceClient;


================================================
File: src/services/llmApi/clients/RequestyServiceClient.ts
================================================
import RequestyChatLog, {
  RequestyChatMessage,
  RequestyChatRequest,
  RequestyChatResponse,
} from "../logs/requestyChatLogs";

import { OllamaModelEnum } from "./OllamaServiceClient";
import axios from "axios";
import dotenv from "dotenv";

dotenv.config();

export interface OpenRouterModelInfo {
  id: string;
  name: string;
  created: number;
  description: string;
  pricing: {
    prompt: string;
    completion: string;
    request: string;
    image: string;
  };
  context_length: number;
  architecture: {
    tokenizer: string;
    instruct_type: string;
    modality: string;
  };
  top_provider: {
    max_completion_tokens: number;
    is_moderated: boolean;
  };
  per_request_limits: {
    prompt_tokens: string;
    completion_tokens: string;
  };
}
export enum RequestyModelEnum {
  o3Mini = "openai/o3-mini",
  geminiFlash2 = "google/gemini-2.0-flash-001",
}

export interface ChatMessage {
  _id?: string;
  sender: "AI Assistant" | "User" | "System";
  content: string;
}

export interface SendChatMessageRequest {
  systemPrompt: string;
  model: RequestyModelEnum | OllamaModelEnum;
  temperature: number;
  messages: ChatMessage[];
  userId: string;
}

export interface OpenRouterListModelsResponse {
  data: OpenRouterModelInfo[];
}
export const transformSenderToRole = (
  message: ChatMessage
): ChatMessageWithRole => {
  const sender = message.sender.toLowerCase().trim();
  const role =
    sender === "ai assistant" || sender === "assistant"
      ? "assistant"
      : sender === "system"
      ? "system"
      : "user";
  return { role, content: message?.content || "" };
};

export const enforceAlternationAndAddContent = (
  messages: ChatMessageWithRole[]
): ChatMessageWithRole[] => {
  const newMessages: ChatMessageWithRole[] = [];
  let lastRole: "user" | "assistant" | "system" | null = null;
  for (let i = 0; i < messages.length; i++) {
    if (messages[i].role === lastRole) {
      newMessages.push({
        content:
          "This is a placeholder message to enforce the User/AI Assistant pattern. Do not let this distract you from the user request",
        role: lastRole === "user" ? "assistant" : "user",
      });
    }
    messages[i].content =
      messages[i]?.content?.trim() ||
      "This is a placeholder message to enforce the User/AI Assistant pattern. Do not let this distract you from the user request";
    newMessages.push(messages[i]);
    lastRole = messages[i].role;
  }
  return newMessages;
};

export interface ChatMessageWithRole {
  role: "user" | "assistant" | "system";
  content: string;
}

class RequestyServiceClient {
  baseUrl: string = "https://router.requesty.ai/v1/chat/completions";
  private static modelsCache: string[] | null = null;
  private static lastCacheTime: number | null = null;
  private static CACHE_DURATION_FOR_MODELS_MS = 12 * 60 * 60 * 1000; // 12 hours in milliseconds

  public fallbackModels = [
    {
      model: null,
      maxAttempts: 2,
    },
  ];
  private static readonly RETRY_DELAY_MS = 1000; // 1 second

  getModel() {
    // can also pick o3Mini or any model supported by Requesty
    return RequestyModelEnum.geminiFlash2;
  }

  async getModels(): Promise<string[]> {
    // Check if cache exists and is still valid
    if (
      RequestyServiceClient.modelsCache &&
      RequestyServiceClient.lastCacheTime &&
      Date.now() - RequestyServiceClient.lastCacheTime <
        RequestyServiceClient.CACHE_DURATION_FOR_MODELS_MS
    ) {
      return RequestyServiceClient.modelsCache;
    }

    const apiKey = process.env.REQUESTY_API_KEY;
    if (!apiKey) {
      throw new Error("API key for Requesty is missing");
    }

    const headers = {
      Authorization: `Bearer ${apiKey}`,
      "Content-Type": "application/json",
    };

    try {
      const response = await axios.get<OpenRouterListModelsResponse>(
        "https://router.requesty.ai/v1/models",
        { headers }
      );

      // Update cache with both original and :online versions
      RequestyServiceClient.modelsCache = response.data.data.flatMap((m) => [
        m.id,
        `${m.id}:online`,
      ]);
      RequestyServiceClient.lastCacheTime = Date.now();

      return RequestyServiceClient.modelsCache;
    } catch (error: any) {
      console.error("Error fetching model list from Requesty:", error.message);
      throw new Error("Failed to list models from Requesty");
    }
  }

  async sendRequest(
    request: SendChatMessageRequest
  ): Promise<RequestyChatResponse> {
    let { model } = request;

    // Try original model first
    try {
      const response = await this.tryRequest(model, request);
      return response;
    } catch (error: any) {
      console.error(`Original model ${model} failed:`, error.message);
    }
    const isOnlineModel = model.endsWith(":online");
    // Try fallback models
    for (const fallback of this.fallbackModels) {
      const fallbackModel = fallback.model
        ? isOnlineModel
          ? `${fallback.model}:online`
          : fallback.model
        : model;

      for (let attempt = 0; attempt < fallback.maxAttempts; attempt++) {
        try {
          const response = await this.tryRequest(fallbackModel, request);
          return response;
        } catch (error: any) {
          console.error(
            `Fallback model ${fallbackModel} attempt ${attempt + 1} failed:`,
            error.message
          );
          await new Promise((resolve) =>
            setTimeout(resolve, RequestyServiceClient.RETRY_DELAY_MS)
          );
        }
      }
    }

    throw new Error(
      "All models and attempts exhausted. Please try again later."
    );
  }

  getChatResponseContent(response: RequestyChatResponse) {
    return response.choices[0].message.content;
  }

  // Helper method to reduce code duplication
  private async tryRequest(model: string, request: SendChatMessageRequest) {
    const { systemPrompt, temperature, messages, userId } = request;
    const systemPromptMessage = {
      sender: "System" as "System",
      content: systemPrompt,
    };

    const openRouterResponse = await this.submitRequest(
      [systemPromptMessage, ...messages],
      userId,
      model,
      temperature
    );

    return openRouterResponse;
  }

  private transformMessagesForModel(
    messages: ChatMessageWithRole[],
    model: string
  ): ChatMessageWithRole[] {
    if (model.includes(RequestyModelEnum.o3Mini)) {
      // add a placeholder message at index 1 if messages[1].role is assistant
      if (messages[1] && messages[1].role === "assistant") {
        messages.splice(1, 0, {
          role: "user",
          content:
            "The below message is an intro message from the AI assistant. It may or may not be relevant to the user's goal. Please keep that in mind.",
        });
      }
      messages = enforceAlternationAndAddContent(messages);
      if (messages[messages.length - 1].role === "assistant") {
        messages.push({
          role: "user",
          content: "Read the above messages and respond.",
        });
      }
    }
    // if its an online model, we should append to the last user message that we should not mention the web search in the response
    if (model.includes(":online")) {
      if (messages[messages.length - 1].role === "user") {
        messages[messages.length - 1].content +=
          "\n\nDo not mention the web search in the response.";
      }
    }
    return messages;
  }

  private async submitRequest(
    messages: ChatMessage[],
    userId: string,
    model: string,
    temperature: number
  ): Promise<RequestyChatResponse> {
    let formattedMessages = messages.map(transformSenderToRole);

    return await this.chat(formattedMessages, userId, model, temperature);
  }

  getError(response: any): string | undefined {
    let error = (response as any).data?.error;
    if (error) {
      return JSON.stringify(error, null, 2);
    }
    return undefined;
  }

  private async chat(
    messages: RequestyChatMessage[],
    userId: string,
    model: string,
    temperature: number
  ): Promise<RequestyChatResponse> {
    const apiKey = process.env.REQUESTY_API_KEY;
    if (!apiKey) {
      throw new Error("API key for Requesty is missing");
    }

    // Prepare request payload
    messages = this.transformMessagesForModel(
      messages as ChatMessageWithRole[],
      model
    );

    const requestPayload: RequestyChatRequest = {
      model,
      user: userId,
      messages,
      temperature,
    };

    const headers = {
      Authorization: `Bearer ${apiKey}`,
      "Content-Type": "application/json",
    };

    const response = await axios.post<RequestyChatResponse>(
      this.baseUrl,
      requestPayload,
      { headers }
    );

    // Check for API-level errors
    const error = this.getError(response);
    if (error) throw new Error(error);

    // Log and return the response
    await RequestyChatLog.logChat(requestPayload, response.data, null);
    return response.data;
  }
}

export default RequestyServiceClient;


================================================
File: src/services/llmApi/logs/ollamaChatLogs.ts
================================================
import mongoose, { Schema } from "mongoose";

import { AiChatTypeEnum } from "./requestyChatLogs";

export interface OllamaChatMessage {
  role: string;
  content: string;
}

export interface OllamaChatRequest {
  model: string;
  messages: OllamaChatMessage[];
  stream: boolean;
  options?: {
    num_ctx?: number;
  };
}

export interface OllamaChatResponse {
  message: {
    role: string;
    content: string;
  };
  done: boolean;
  total_duration?: number;
  load_duration?: number;
  prompt_eval_duration?: number;
}

interface OllamaChatLog {
  type: AiChatTypeEnum;
  request: OllamaChatRequest;
  response: OllamaChatResponse;
  createdAt: Date;
  error?: string;
}

const OllamaChatLogSchema = new Schema({
  type: { type: String, required: true },
  request: { type: Object, required: true },
  response: { type: Object },
  error: { type: String },
  createdAt: { type: Date, default: Date.now },
});

const OllamaChatLogModel = mongoose.model<OllamaChatLog & mongoose.Document>(
  "OllamaChatLog",
  OllamaChatLogSchema
);

class OllamaChatLog {
  static async getFullLogs() {
    return await OllamaChatLogModel.find();
  }

  static async logChat(
    request: OllamaChatRequest,
    response: OllamaChatResponse | null,
    error: string | null
  ) {
    if (error) {
      console.log("Ollama Chat Error: ", error);
    }
    const log = new OllamaChatLogModel({
      type: AiChatTypeEnum.Chat,
      request,
      response,
      error,
    });

    await log.save().catch((err) => console.log("Error saving log: ", err));
  }
}

export default OllamaChatLog;


================================================
File: src/services/llmApi/logs/requestyChatLogs.ts
================================================
import mongoose, { Schema } from "mongoose";

export enum AiChatTypeEnum {
  Image = "image",
  Embeddings = "embeddings",
  Chat = "chat",
}

export interface IJson {
  name: string;
  description: string;
  parameters: any;
  strict?: boolean;
  additionalProperties?: false;
}

export interface ToolCall {
  id: string;
  type: "function";
  function: {
    name: string;
    arguments: string;
  };
}

export interface RequestyChatMessage {
  role: string;
  content: string | null;
  tool_calls?: ToolCall[];
}

export interface RequestyChatRequest {
  model: string;
  user: string;
  messages: RequestyChatMessage[];
  temperature: number;
  max_tokens?: number;
  tools?: Array<{ type: "function"; function: IJson }>;
  presence_penalty?: number;
  frequency_penalty?: number;
  response_format?: { type: "json_object" };
  seed?: number;
}

export interface RequestyUsage {
  prompt_tokens: number;
  completion_tokens: number;
  total_tokens: number;
}

export interface RequestyChoice {
  index: number;
  finish_reason: string;
  message: RequestyChatMessage;
}

export interface RequestyChatResponse {
  usage: RequestyUsage;
  choices: RequestyChoice[];
  created: number;
}

interface RequestyChatLog {
  type: AiChatTypeEnum;
  request: RequestyChatRequest;
  response: RequestyChatResponse;
  createdAt: Date;
  error?: string;
}

const RequestyChatLogSchema = new Schema({
  type: { type: String, required: true },
  request: { type: Object, required: true },
  response: { type: Object },
  error: { type: String },
  createdAt: { type: Date, default: Date.now },
});

const RequestyChatLogModel = mongoose.model<
  RequestyChatLog & mongoose.Document
>("RequestyChatLog", RequestyChatLogSchema);

class RequestyChatLog {
  static async getFullLogs() {
    return await RequestyChatLogModel.find();
  }

  static async logChat(
    request: RequestyChatRequest,
    response: RequestyChatResponse | null,
    error: string | null
  ) {
    if (error) {
      console.log("Requesty Chat Error: ", error);
    }
    const log = new RequestyChatLogModel({
      type: AiChatTypeEnum.Chat,
      request,
      response,
      error,
    });

    await log.save().catch((err) => console.log("Error saving log: ", err));
  }
}

export default RequestyChatLog;


